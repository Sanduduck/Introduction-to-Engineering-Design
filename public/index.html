<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>ì¤‘ê³ ë“±í•™ìƒ 3D êµìœ¡ ë„ì›€ ì‹œìŠ¤í…œ</title>
        <link rel="icon" type="image/png" href="/images/invert_logo.png" />
        <meta
            name="description"
            content="íŒŒì¼(models.json) ë˜ëŠ” /api/models ê¸°ë°˜ êµìœ¡ìš© ëª¨ë¸ ì¹´íƒˆë¡œê·¸. ê³¼ëª© í•„í„° + ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ + ë§ˆì´í˜ì´ì§€(+ê´€ë¦¬ì ì°¨ë‹¨) + Sketchfab ì„ë² ë“œ íŒì—…."
        />
        <link
            href="https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css"
            rel="stylesheet"
        />

        <style>
            .flex-parent > * {
                min-width: 0;
            }
            :root {
                --c1: #bc2c3c;
                --c2: #4e77ba;
                --bg: #f7f7f8;
                --card: #fff;
                --text: #111;
                --muted: #666;
                --bd: #e6e6e8;
                --ring: #4e77ba;
                --danger: #e63946;
                --ok: #16a34a;
                --shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
                --radius: 16px;
                --login-color: #4ad395;
                --login-dark: #23004d;
                --login-light: #a49eac;
                --login-lighten: #f2f2f2;
                --login-hover: #65bf97;
                --login-font: 'Open Sans', sans-serif;
                --login-big: 1.5rem;
                --login-normal: 0.938rem;
                --login-small: 0.813rem;
            }
            *,
            *::before,
            *::after {
                box-sizing: border-box;
            }
            body {
                margin: 0;
                font: 14px/1.6 Pretendard, system-ui, -apple-system, Segoe UI,
                    Roboto, Noto Sans KR;
                color: var(--text);
                background: var(--bg);
            }
            .no-scroll {
                overflow: hidden;
            }
            .container {
                max-width: 1280px;
                margin: 0 auto;
                padding: 0 16px;
            }
            header {
                position: sticky;
                top: 0;
                z-index: 50;
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid var(--bd);
            }
            .nav {
                display: flex;
                align-items: center;
                justify-content: space-between;
                height: 64px;
                gap: 12px;
            }
            .brand {
                font-size: 1.2rem;
                display: inline-flex;
                align-items: center;
                gap: 0.6rem;
                font-weight: 800;
                text-decoration: none;
                color: var(--text);
            }
            .brand:hover {
                opacity: 0.85;
            }
            .logo {
                width: 28px;
                height: 28px;
                border-radius: 9px;
                background: linear-gradient(135deg, var(--c1), var(--c2));
            }
            .search {
                flex: 1;
                display: flex;
                align-items: center;
                gap: 8px;
                background: #fff;
                border: 1px solid var(--bd);
                border-radius: 14px;
                padding: 8px 10px;
                margin: 0 16px;
            }
            .search input {
                border: 0;
                outline: 0;
                flex: 1;
                font: inherit;
            }
            .btn {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                border: 1px solid var(--bd);
                background: #fff;
                border-radius: 12px;
                padding: 8px 12px;
                text-decoration: none;
                cursor: pointer;
                transition: 0.2s;
            }
            .btn:hover {
                transform: translateY(-1px);
            }
            .btn.primary {
                background: linear-gradient(90deg, var(--c1), var(--c2));
                border: none;
                color: #fff;
                box-shadow: var(--shadow);
            }
            .btn.ghost {
                background: #fff;
                border: 1px solid var(--bd);
                color: #333;
            }

            /* Filter Bar */
            .filterbar {
                background: #fff;
                border-top: 1px solid var(--bd);
                border-bottom: 1px solid var(--bd);
            }
            .filters {
                display: flex;
                align-items: center;
                flex-wrap: wrap;
                gap: 12px;
                padding: 10px 0;
            }
            .filters .group {
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
            }
            .filters input[type='checkbox'] {
                width: 16px;
                height: 16px;
            }
            .filters label {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 10px;
                border: 1px solid var(--bd);
                border-radius: 999px;
                cursor: pointer;
                user-select: none;
            }
            .filters .clear {
                margin-left: auto;
            }

            /* Layout */
            main {
                padding: 16px 0;
            }
            .results {
                display: grid;
                grid-template-columns: repeat(4, minmax(0, 1fr));
                gap: 16px;
            }
            @media (max-width: 1200px) {
                .results {
                    grid-template-columns: repeat(3, 1fr);
                }
            }
            @media (max-width: 900px) {
                .results {
                    grid-template-columns: repeat(2, 1fr);
                }
            }
            @media (max-width: 520px) {
                .results {
                    grid-template-columns: 1fr;
                }
            }

            .item {
                display: flex;
                flex-direction: column;
                overflow: hidden;
                background: var(--card);
                border: 1px solid var(--bd);
                border-radius: var(--radius);
                position: relative;
            }
            .thumb {
                aspect-ratio: 1.2/1;
                background: #e9e9ee;
                display: grid;
                place-items: center;
                color: #888;
                border-bottom: 1px solid var(--bd);
                cursor: pointer;
                position: relative;
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
            }
            .thumb::after {
                content: 'í´ë¦­í•˜ì—¬ ë¯¸ë¦¬ë³´ê¸°';
                position: absolute;
                bottom: 8px;
                right: 8px;
                background: rgba(17, 17, 17, 0.75);
                color: #fff;
                font-size: 0.75rem;
                padding: 4px 8px;
                border-radius: 8px;
                z-index: 1;
                pointer-events: none;
            }
            /* ì‚­ì œ ë²„íŠ¼: ë©”ì¸ì—ì„œëŠ” í•­ìƒ ìˆ¨ê¹€(ê´€ë¦¬ì ê¸°ëŠ¥ì€ /admin ì „ìš©) */
            .thumb-del {
                display: none;
            }

            /* â˜… ë¶ë§ˆí¬ ë²„íŠ¼: ìš°ìƒë‹¨ìœ¼ë¡œ ì´ë™ */
            .bookmark-btn {
                position: absolute;
                top: 8px;
                right: 8px;
                left: auto;
                z-index: 2;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: inline-grid;
                place-items: center;
                background: rgba(255, 255, 255, 0.95);
                border: 1px solid var(--bd);
                cursor: pointer;
                box-shadow: var(--shadow);
                line-height: 1;
            }
            .bookmark-btn i {
                font-size: 18px;
            }
            .bookmark-btn.active {
                background: #fff;
            }
            .bookmark-btn:hover {
                filter: brightness(0.96);
            }

            .meta {
                padding: 10px;
                text-align: left;
            }
            .title {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-weight: 700;
                text-align: left;
            }
            .sub {
                display: -webkit-box;
                -webkit-box-orient: vertical;
                -webkit-line-clamp: 3; /* ë³´ì—¬ì¤„ ì¤„ ìˆ˜ */
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: normal; /* ê¸°ì¡´ nowrap ë¬´íš¨í™” */

                color: var(--muted);
                font-size: 0.85rem;
                margin-top: 2px;
                text-align: left;
            }

            /* Firefox ë“± WebKit ë¯¸ì§€ì›ìš© ëŒ€ì²´ */
            @supports not (-webkit-line-clamp: 3) {
                .sub {
                    display: block;
                    line-height: 1.4;
                    max-height: calc(1.4em * 3); /* 3ì¤„ ë†’ì´ê¹Œì§€ë§Œ ë³´ì´ê²Œ */
                    overflow: hidden;
                }
            }
            /* Modal */
            .modal {
                position: fixed;
                inset: 0;
                display: none;
                place-items: center;
                background: rgba(17, 17, 17, 0.6);
                backdrop-filter: blur(2px);
                z-index: 100;
            }
            .modal.open {
                display: grid;
            }
            .dialog {
                width: min(1000px, 92vw);
                background: #000;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                overflow: hidden;
            }
            .dialog-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 12px 14px;
                background: #111;
                color: #eee;
            }
            .dialog-title {
                font-weight: 700;
                font-size: 0.95rem;
            }
            .dialog-close {
                background: transparent;
                border: 0;
                color: #ddd;
                font-size: 18px;
                cursor: pointer;
            }
            .dialog-body {
                aspect-ratio: 16/9;
                background: #000;
            }
            .dialog-body iframe {
                width: 100%;
                height: 100%;
                border: 0;
            }

            /* Light dialog (Login/MyPage) */
            .dialog.light {
                background: #fff;
                color: #111;
            }
            .dialog.light .dialog-header {
                background: #f6f7fb;
                color: #111;
                border-bottom: 1px solid var(--bd);
            }
            .dialog.light .dialog-body {
                aspect-ratio: auto;
                padding: 0;
            }

            /* ğŸ‘ AI ê²€ìƒ‰ í† ê¸€ ìŠ¤ìœ„ì¹˜ */
            .ai-toggle-wrapper {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                margin-left: 10px;
                font-size: 14px;
                color: #666;
            }

            .ai-toggle {
                position: relative;
                display: inline-block;
                width: 48px;
                height: 24px;
            }

            .ai-toggle input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .ai-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: 0.4s;
                border-radius: 24px;
            }

            .ai-slider:before {
                position: absolute;
                content: '';
                height: 18px;
                width: 18px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                transition: 0.4s;
                border-radius: 50%;
            }

            input:checked + .ai-slider {
                background-color: #2196f3;
            }

            input:checked + .ai-slider:before {
                transform: translateX(24px);
            }

            .ai-toggle-label {
                user-select: none;
                cursor: pointer;
            }

            /* Footer */
            footer {
                border-top: 1px solid var(--bd);
                color: #777;
            }
            footer .inner {
                padding: 14px 0;
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 8px;
            }

            /* ===== Login Component (compiled) ===== */
            .login * {
                box-sizing: border-box;
            }
            .login {
                display: grid;
                grid-template-columns: 100%;
                height: 100vh;
                margin: 0 1.5rem;
            }
            .login__content {
                display: grid;
            }
            .login__img {
                justify-self: center;
            }
            .login__img img {
                width: 310px;
                margin-top: 1.5rem;
            }
            .login__forms {
                position: relative;
                height: 368px;
            }
            .login__register,
            .login__create {
                position: absolute;
                bottom: 1rem;
                width: 100%;
                background-color: var(--login-lighten);
                padding: 2rem 1rem;
                border-radius: 1rem;
                text-align: center;
                box-shadow: 0 8px 20px rgba(35, 0, 77, 0.2);
                animation-duration: 0.4s;
                animation-name: animateLogin;
            }
            .login__title {
                font-size: var(--login-big);
                margin-bottom: 2rem;
                font-family: var(--login-font);
            }
            .login__box {
                display: grid;
                grid-template-columns: max-content 1fr;
                column-gap: 0.5rem;
                padding: 1.125rem 1rem;
                background-color: #fff;
                margin-top: 1rem;
                border-radius: 0.5rem;
            }
            .login__icon {
                font-size: 1.5rem;
                color: var(--login-color);
            }
            .login__input {
                border: none;
                outline: none;
                font-size: var(--login-normal);
                font-weight: 700;
                color: var(--login-dark);
                width: 100%;
                font-family: var(--login-font);
            }
            .login__input::placeholder {
                font-size: var(--login-normal);
                font-family: var(--login-font);
                color: var(--login-light);
            }
            .login__forgot {
                display: block;
                width: max-content;
                margin-left: auto;
                margin-top: 0.5rem;
                font-size: var(--login-small);
                font-weight: 600;
                color: var(--login-light);
            }
            .login__button {
                display: block;
                padding: 1rem;
                margin: 2rem 0;
                background-color: var(--login-color);
                color: #fff;
                font-weight: 600;
                text-align: center;
                border-radius: 0.5rem;
                transition: 0.3s;
            }
            .login__button:hover {
                background-color: var(--login-hover);
            }
            .login__account,
            .login__signin,
            .login__signup {
                font-weight: 600;
                font-size: var(--login-small);
            }
            .login__account--account {
                color: var(--login-dark);
            }
            .login__signin--signup,
            .login__signup--signup {
                color: var(--login-color);
                cursor: pointer;
            }
            .login__social {
                margin-top: 2rem;
            }
            .login__social--icon {
                font-size: 1.5rem;
                color: var(--login-dark);
                margin: 0 1rem;
            }
            .block {
                display: block;
            }
            .none {
                display: none;
            }
            @keyframes animateLogin {
                0% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.1);
                }
                100% {
                    transform: scale(1);
                }
            }
            @media (min-width: 576px) {
                .login__forms {
                    width: 348px;
                    justify-self: center;
                }
            }
            @media (min-width: 1024px) {
                .login {
                    height: 100vh;
                    overflow: hidden;
                }
                .login__content {
                    grid-template-columns: repeat(2, max-content);
                    justify-content: center;
                    align-items: center;
                    margin-left: 10rem;
                }
                .login__img {
                    display: flex;
                    width: 600px;
                    height: 588px;
                    background-color: #fff;
                    border-radius: 1rem;
                    padding-left: 1rem;
                }
                .login__img img {
                    width: 80%;
                    margin-top: 0;
                }
                .login__register,
                .login__create {
                    left: -11rem;
                }
                .login__register {
                    bottom: -2rem;
                }
                .login__create {
                    bottom: -5.5rem;
                }
            }

            /* ===== My Page (simple) ===== */
            .mypage {
                padding: 18px;
            }
            .mypage .row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }
            @media (max-width: 720px) {
                .mypage .row {
                    grid-template-columns: 1fr;
                }
            }
            .mypage .card {
                border: 1px solid var(--bd);
                border-radius: 12px;
                padding: 14px;
                background: #fff;
            }
            .mypage h3 {
                margin: 0 0 8px 0;
            }
            /* ë¡œê³  ì „ìš© ìŠ¤íƒ€ì¼ */
            .brand-logo {
                height: 2em; /* ì œëª© í¬ê¸°ì— ë§ì¶¤ */
                width: auto;
                vertical-align: middle;
                border-radius: 6px; /* ì‚´ì§ ë‘¥ê·¼ ëª¨ì„œë¦¬ */
                filter: invert(1);
            }

            /* ================== ğŸ ì±—ë´‡ UI ìŠ¤íƒ€ì¼ ================== */
            /* ìš°í•˜ë‹¨ Floating ë²„íŠ¼ */
            .floating-chat-btn {
                position: fixed;
                bottom: 24px;
                right: 24px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: linear-gradient(135deg, var(--c1), var(--c2));
                border: none;
                font-size: 28px;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 999;
                transition: transform 0.2s;
                display: flex; /* ğŸ ì„ì‹œ: í•­ìƒ í‘œì‹œ (í…ŒìŠ¤íŠ¸ìš©) */
                align-items: center;
                justify-content: center;
            }
            .floating-chat-btn:hover {
                transform: scale(1.1);
            }

            /* ì±—ë´‡ ëª¨ë‹¬ */
            .chat-modal {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(3px);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }
            .chat-modal.open {
                display: flex;
            }

            /* ì±—ë´‡ ì»¨í…Œì´ë„ˆ */
            .chat-container {
                width: min(500px, 90vw);
                height: min(680px, 85vh);
                background: #fff;
                border-radius: 16px;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                box-shadow: var(--shadow);
            }

            /* ì±—ë´‡ í—¤ë” */
            .chat-header {
                background: linear-gradient(90deg, var(--c1), var(--c2));
                color: #fff;
                padding: 14px 16px;
                display: flex;
                align-items: center;
                gap: 10px;
                flex-shrink: 0;
            }
            .chat-header h3 {
                flex: 1;
                margin: 0;
                font-size: 1rem;
                font-weight: 700;
            }
            .chat-header select {
                padding: 6px 10px;
                border: none;
                border-radius: 8px;
                font-size: 0.85rem;
                background: rgba(255, 255, 255, 0.9);
                cursor: pointer;
            }
            .chat-header .dialog-close {
                background: transparent;
                border: none;
                color: #fff;
                font-size: 24px;
                cursor: pointer;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
            }
            .chat-header .dialog-close:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            /* ë©”ì‹œì§€ ì˜ì—­ */
            .chat-messages {
                flex: 1;
                overflow-y: auto;
                padding: 16px;
                display: flex;
                flex-direction: column;
                gap: 12px;
                background: #f9f9f9;
            }

            /* ê°œë³„ ë©”ì‹œì§€ */
            .chat-message {
                display: flex;
                gap: 8px;
                max-width: 85%;
                animation: fadeIn 0.3s;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .chat-message.user {
                align-self: flex-end;
                flex-direction: row-reverse;
            }

            .chat-message .bubble {
                padding: 10px 14px;
                border-radius: 12px;
                background: #fff;
                word-wrap: break-word;
                line-height: 1.5;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            }
            .chat-message.user .bubble {
                background: var(--c2);
                color: #fff;
            }

            .chat-message .save-note-btn {
                margin-top: 8px;
                padding: 6px 12px;
                font-size: 0.8rem;
                background: var(--ok);
                color: #fff;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                display: inline-block;
                transition: 0.2s;
            }
            .chat-message .save-note-btn:hover {
                background: #15803d;
                transform: translateY(-1px);
            }

            /* ì…ë ¥ ì˜ì—­ */
            .chat-input-wrapper {
                border-top: 1px solid var(--bd);
                padding: 12px;
                background: #fff;
                flex-shrink: 0;
            }
            .chat-quick-actions {
                display: flex;
                gap: 6px;
                margin-bottom: 8px;
            }
            .chat-quick-btn {
                padding: 4px 10px;
                font-size: 0.75rem;
                background: #f0f0f0;
                border: 1px solid var(--bd);
                border-radius: 6px;
                cursor: pointer;
                transition: 0.2s;
            }
            .chat-quick-btn:hover {
                background: #e0e0e0;
            }

            .chat-input-box {
                display: flex;
                gap: 8px;
            }
            .chat-input-box input {
                flex: 1;
                padding: 10px 12px;
                border: 1px solid var(--bd);
                border-radius: 8px;
                font: inherit;
                outline: none;
            }
            .chat-input-box input:focus {
                border-color: var(--c2);
            }
            .chat-input-box button {
                padding: 10px 18px;
                background: var(--c2);
                color: #fff;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: 0.2s;
            }
            .chat-input-box button:hover {
                background: #3d5a8d;
            }
            .chat-input-box button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }
        </style>

        <link
            href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap"
            rel="stylesheet"
        />
    </head>
    <body>
        <header>
            <div class="container nav">
                <a class="brand" id="brandHome" href="/">
                    <img src="images/logo.png" alt="ë¡œê³ " class="brand-logo" />
                    ì¤‘ê³ ë“±í•™ìƒ 3D êµìœ¡ ë„ì›€ ì‹œìŠ¤í…œ
                </a>
                <div class="search">
                    ğŸ”<input
                        id="q"
                        placeholder="ëª¨ë¸/ì„¤ëª… ê²€ìƒ‰ (ì˜ˆ: ì„¸í¬, í™”ì‚°, DNA, ê´‘í•™)"
                    />
                    <button class="btn" id="btnSearch">ê²€ìƒ‰</button>
                    <!-- ğŸ‘ AI ê²€ìƒ‰ í† ê¸€ ìŠ¤ìœ„ì¹˜ -->
                    <div class="ai-toggle-wrapper">
                        <label class="ai-toggle">
                            <input
                                type="checkbox"
                                id="aiSearchToggle"
                                checked
                            />
                            <span class="ai-slider"></span>
                        </label>
                        <label for="aiSearchToggle" class="ai-toggle-label">
                            ğŸ¤– AI ê²€ìƒ‰
                        </label>
                    </div>
                </div>
                <div style="display: flex; gap: 8px">
                    <button class="btn primary" id="btnAuth" type="button">
                        ë¡œê·¸ì¸
                    </button>
                    <button
                        class="btn ghost"
                        id="btnLogout"
                        type="button"
                        style="display: none"
                    >
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
            <div class="filterbar">
                <div class="container filters">
                    <div class="group" id="subjectGroup">
                        <label
                            ><input
                                type="checkbox"
                                class="subject-chk"
                                value="biology"
                            />ìƒëª…ê³¼í•™</label
                        >
                        <label
                            ><input
                                type="checkbox"
                                class="subject-chk"
                                value="earth"
                            />ì§€êµ¬ê³¼í•™</label
                        >
                        <label
                            ><input
                                type="checkbox"
                                class="subject-chk"
                                value="physics"
                            />ë¬¼ë¦¬í•™</label
                        >
                        <label
                            ><input
                                type="checkbox"
                                class="subject-chk"
                                value="chemistry"
                            />í™”í•™</label
                        >
                        <label
                            ><input
                                type="checkbox"
                                class="subject-chk"
                                value="geography"
                            />ì§€ë¦¬í•™</label
                        >
                    </div>
                    <button class="btn clear" id="btnClear" type="button">
                        ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </header>

        <main class="container">
            <div id="count" class="muted" style="margin-bottom: 8px"></div>
            <div class="results" id="results"></div>
            <div
                class="pager"
                id="pager"
                style="text-align: center; margin-top: 16px"
            ></div>
        </main>

        <!-- Model Viewer Modal -->
        <div
            class="modal"
            id="modal"
            aria-hidden="true"
            role="dialog"
            aria-modal="true"
            tabindex="-1"
        >
            <div class="dialog">
                <div class="dialog-header">
                    <div class="dialog-title" id="modalTitle">ë¯¸ë¦¬ë³´ê¸°</div>
                    <button
                        class="dialog-close"
                        id="btnClose"
                        type="button"
                        aria-label="ë‹«ê¸°"
                    >
                        âœ•
                    </button>
                </div>
                <div class="dialog-body">
                    <iframe
                        id="viewer"
                        allow="autoplay; fullscreen; xr-spatial-tracking"
                        xr-spatial-tracking
                        execution-while-out-of-viewport
                        execution-while-not-rendered
                        web-share
                        allowfullscreen
                        mozallowfullscreen="true"
                        webkitallowfullscreen="true"
                    ></iframe>
                </div>
            </div>
        </div>

        <!-- Login Modal (ë©”ì¸ì—ì„œëŠ” ê´€ë¦¬ì ë¡œê·¸ì¸ ì°¨ë‹¨) -->
        <div
            class="modal"
            id="modalLogin"
            aria-hidden="true"
            role="dialog"
            aria-modal="true"
            tabindex="-1"
        >
            <div class="login">
                <div class="login__content">
                    <div class="login__img">
                        <img
                            src="https://image.freepik.com/free-vector/code-typing-concept-illustration_114360-3581.jpg"
                            alt="user login"
                        />
                    </div>
                    <div class="login__forms">
                        <form
                            action="#"
                            class="login__register block"
                            id="login-in"
                        >
                            <h1 class="login__title">Sign In</h1>
                            <div class="login__box">
                                <i class="bx bx-user login__icon"></i>
                                <input
                                    id="loginUsername"
                                    type="text"
                                    placeholder="Username"
                                    class="login__input"
                                    required
                                />
                            </div>
                            <div class="login__box">
                                <i class="bx bx-lock login__icon"></i>
                                <input
                                    id="loginPw"
                                    type="password"
                                    placeholder="Password"
                                    class="login__input"
                                    required
                                />
                            </div>
                            <button
                                class="login__button"
                                id="btnSignIn"
                                type="submit"
                            >
                                Sign In
                            </button>
                            <div>
                                <span
                                    class="login__account login__account--account"
                                    >Don't Have an Account?</span
                                >
                                <span
                                    class="login__signin login__signin--signup"
                                    id="sign-up"
                                    >Sign Up</span
                                >
                            </div>
                        </form>

                        <form
                            action="#"
                            class="login__create none"
                            id="login-up"
                        >
                            <h1 class="login__title">Create Account</h1>
                            <div class="login__box">
                                <i class="bx bx-user login__icon"></i>
                                <input
                                    id="signupUsername"
                                    type="text"
                                    placeholder="Username"
                                    class="login__input"
                                    required
                                />
                            </div>
                            <div class="login__box">
                                <i class="bx bx-at login__icon"></i>
                                <input
                                    id="signupEmail"
                                    type="email"
                                    placeholder="Email (optional)"
                                    class="login__input"
                                />
                            </div>
                            <div class="login__box">
                                <i class="bx bx-lock login__icon"></i>
                                <input
                                    id="signupPw"
                                    type="password"
                                    placeholder="Password"
                                    class="login__input"
                                    required
                                />
                            </div>
                            <button
                                class="login__button"
                                id="btnSignUp"
                                type="submit"
                            >
                                Sign Up
                            </button>
                            <div>
                                <span
                                    class="login__account login__account--account"
                                    >Already have an Account?</span
                                >
                                <span
                                    class="login__signup login__signup--signup"
                                    id="sign-in"
                                    >Sign In</span
                                >
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Page Modal (ê°„ë‹¨ ë²„ì „ â€” ë²„íŠ¼ ì „í™˜ìš©) -->
        <div
            class="modal"
            id="modalMypage"
            aria-hidden="true"
            role="dialog"
            aria-modal="true"
            tabindex="-1"
        >
            <div class="dialog light" style="width: min(720px, 92vw)">
                <div class="dialog-header">
                    <div class="dialog-title">ë§ˆì´í˜ì´ì§€</div>
                    <button
                        class="dialog-close"
                        id="btnCloseMypage"
                        type="button"
                        aria-label="ë‹«ê¸°"
                    >
                        âœ•
                    </button>
                </div>
                <div class="dialog-body">
                    <div class="mypage">
                        <div class="row">
                            <div class="card">
                                <h3>ë‚´ ì •ë³´</h3>
                                <div id="myUser">-</div>
                            </div>
                            <div class="card">
                                <h3>ì¦ê²¨ì°¾ê¸° (ì˜ˆì •)</h3>
                                <div class="muted">
                                    ì¶”í›„ ë¶ë§ˆí¬/ìµœê·¼ ë³¸ í•­ëª© ë“±ì„ ë³´ì—¬ì¤„
                                    ì˜ˆì •ì…ë‹ˆë‹¤.
                                </div>
                            </div>
                        </div>
                        <div
                            style="
                                margin-top: 12px;
                                display: flex;
                                gap: 8px;
                                justify-content: flex-end;
                            "
                        >
                            <button class="btn ghost" id="btnMypageLogout">
                                ë¡œê·¸ì•„ì›ƒ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div
            id="toast"
            style="
                position: fixed;
                top: 20px;
                left: 50%;
                right: auto;
                z-index: 9999;
                transform: translate(-50%, -12px);
                opacity: 0;
                background: rgba(17, 17, 17, 0.9);
                color: #fff;
                padding: 12px 16px;
                border-radius: 10px;
                font-weight: 700;
                font-size: 0.95rem;
                text-align: center;
                max-width: 90vw;
                pointer-events: none;
                transition: opacity 0.25s, transform 0.25s;
            "
        ></div>

        <footer>
            <div class="container inner">
                <div>Â© <span id="year"></span> Model Catalog</div>
                <div>
                    <a href="#" onclick="event.preventDefault()">Privacy</a> Â·
                    <a href="#" onclick="event.preventDefault()">Terms</a>
                </div>
            </div>
        </footer>

        <!-- ğŸ ì±—ë´‡ Floating ë²„íŠ¼ -->
        <button
            class="floating-chat-btn"
            id="chatbotBtn"
            title="í•™ìŠµ ë„ìš°ë¯¸ ì±—ë´‡"
        >
            ğŸ¤–
        </button>

        <!-- ğŸ ì±—ë´‡ ëª¨ë‹¬ -->
        <div class="chat-modal" id="chatModal">
            <div class="chat-container">
                <div class="chat-header">
                    <h3>ğŸ í•™ìŠµ ë„ìš°ë¯¸</h3>
                    <select id="chatSubject" title="ê³¼ëª© ì„ íƒ">
                        <option value="">ê³¼ëª© ì„ íƒ</option>
                        <option value="biology">ìƒëª…ê³¼í•™</option>
                        <option value="physics">ë¬¼ë¦¬í•™</option>
                        <option value="chemistry">í™”í•™</option>
                        <option value="earth">ì§€êµ¬ê³¼í•™</option>
                        <option value="geography">ì§€ë¦¬í•™</option>
                    </select>
                    <button
                        class="dialog-close"
                        id="closeChatBtn"
                        aria-label="ë‹«ê¸°"
                    >
                        âœ•
                    </button>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message">
                        <div class="bubble">
                            ì•ˆë…•í•˜ì„¸ìš”! í•™ìŠµ ë„ìš°ë¯¸ì…ë‹ˆë‹¤ ğŸ˜Š<br />
                            ê³¼ëª©ì„ ì„ íƒí•˜ê³  ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”!
                        </div>
                    </div>
                </div>

                <div class="chat-input-wrapper">
                    <button id="quizBtn">ğŸ“ í€´ì¦ˆ ìš”ì²­</button>
                    <input id="chatInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." />
                    <button id="sendChatBtn">ì „ì†¡</button>
                </div>
            </div>
        </div>

        <!-- Fallback data -->
        <script type="application/json" id="models-json">
            [
                {"id":1,"title":"ì„¸í¬ êµ¬ì¡° #1","description":"ì„¸í¬ì˜ ê¸°ë³¸ êµ¬ì¡°ì™€ ì†Œê¸°ê´€ ë°°ì¹˜ë¥¼ ì‚´í´ë³¼ ìˆ˜ ìˆëŠ” ëª¨ë¸","url":"https://sketchfab.com/3d-models/make-your-own-steampunk-house-0bceb4f2d7444809b022ba864ac03df3","thumb":"thumbs/cell-1.png","subject":"biology"},
                {"id":2,"title":"ì§€êµ¬ ë‹¨ë©´ #2","description":"ì§€ê°â€“ë§¨í‹€â€“í•µì˜ ì¸µìƒì„ ë‹¨ë©´ìœ¼ë¡œ í‘œí˜„","url":"https://sketchfab.com/3d-models/make-your-own-steampunk-house-0bceb4f2d7444809b022ba864ac03df3","thumb":"thumbs/earth-2.png","subject":"earth"},
                {"id":3,"title":"ì›ì ëª¨ë¸ #3","description":"ì›ìí•µê³¼ ì „ìê»ì§ˆì˜ ê°œë…ì„ ì‹œê°í™”","url":"https://sketchfab.com/3d-models/make-your-own-steampunk-house-0bceb4f2d7444809b022ba864ac03df3","thumb":"thumbs/atom-3.png","subject":"chemistry"},
                {"id":4,"title":"ê´‘í•™ ì‹¤í—˜ #4","description":"ë Œì¦ˆë¥¼ í†µí•œ êµ´ì ˆê³¼ ìƒì˜ í˜•ì„± ì›ë¦¬","url":"https://sketchfab.com/3d-models/make-your-own-steampunk-house-0bceb4f2d7444809b022ba864ac03df3","thumb":"thumbs/optics-4.png","subject":"physics"}
        </script>

        <script>
            /* ====== Utils ====== */
            const qs = (s) => document.querySelector(s);
            const qsa = (s) => [...document.querySelectorAll(s)];
            function showToast(msg, bg = '#16a34a') {
                const t = document.getElementById('toast');
                if (!t) return;
                t.textContent = msg;
                t.style.background = bg;
                t.style.opacity = '1';
                t.style.transform = 'translate(-50%, 0)'; // ê°€ìš´ë°ì—ì„œ ì•„ë˜ë¡œ ì‚´ì§
                clearTimeout(t._timer);
                t._timer = setTimeout(() => {
                    t.style.opacity = '0';
                    t.style.transform = 'translate(-50%, -12px)'; // ìœ„ë¡œ ì‚¬ë¼ì§
                }, 1800);
            }
            function openLoginModal() {
                const mod = qs('#modalLogin');
                if (!mod) return;
                mod.classList.add('open');
                mod.focus();
                document.body.classList.add('no-scroll');
            }
            function closeLoginModal() {
                const mod = document.querySelector('#modalLogin');
                if (!mod) return;
                mod.classList.remove('open');
                document.body.classList.remove('no-scroll');
            }
            let MODELS = [];
            const SUBJECTS = {
                biology: {
                    label: 'ìƒëª…ê³¼í•™',
                    keywords: [
                        'ì„¸í¬',
                        'DNA',
                        'ìƒëª…',
                        'ìƒë¬¼',
                        'ìœ ì „',
                        'ë‹¨ë°±ì§ˆ',
                        'ê´‘í•©ì„±',
                    ],
                },
                earth: {
                    label: 'ì§€êµ¬ê³¼í•™',
                    keywords: [
                        'ì§€êµ¬',
                        'ë‹¨ë©´',
                        'íŒ êµ¬ì¡°',
                        'í™”ì‚°',
                        'ì§€ì§„',
                        'ëŒ€ê¸°',
                        'ê¸°ìƒ',
                        'ì§€ì§ˆ',
                    ],
                },
                physics: {
                    label: 'ë¬¼ë¦¬í•™',
                    keywords: [
                        'ê´‘í•™',
                        'íŒŒë™',
                        'ì „ê¸°',
                        'ìê¸°',
                        'ì—­í•™',
                        'ìš´ë™',
                        'ë Œì¦ˆ',
                    ],
                },
                chemistry: {
                    label: 'í™”í•™',
                    keywords: [
                        'ì›ì',
                        'ë¶„ì',
                        'í™”í•©ë¬¼',
                        'ì‹¤í—˜',
                        'ê¸°êµ¬',
                        'ë°˜ì‘',
                        'ì£¼ê¸°ìœ¨',
                    ],
                },
                geography: {
                    label: 'ì§€ë¦¬í•™',
                    keywords: ['ì§€í˜•', 'ì‚¼ê°ì£¼', 'í˜‘ê³¡', 'ì§€ë¦¬', 'ì§€ë„'],
                },
            };
            const state = {
                q: '',
                page: 1,
                per: 12,
                sort: 'relevance',
                subject: null,
                isLoggedIn: false,
                user: null,
                currentUser: null, // ğŸ ì±—ë´‡ ë²„íŠ¼ í‘œì‹œìš©
                bookmarks: new Set(),
                useAISearch: true, // ğŸ‘ AI ê²€ìƒ‰ ì‚¬ìš© ì—¬ë¶€ (ê¸°ë³¸ê°’: true)
            };

            // ---- ìë™ ì¸ë„¤ì¼ (ìº”ë²„ìŠ¤) ----
            const THUMB_CACHE = new Map();
            function hashCode(str) {
                let h = 0;
                for (let i = 0; i < str.length; i++) {
                    h = (h << 5) - h + str.charCodeAt(i);
                    h |= 0;
                }
                return Math.abs(h);
            }
            function pickColors(key) {
                const palette = [
                    ['#4e77ba', '#bc2c3c'],
                    ['#3aa675', '#0e7490'],
                    ['#7c3aed', '#fb7185'],
                    ['#f59e0b', '#ef4444'],
                    ['#2563eb', '#16a34a'],
                    ['#9333ea', '#3b82f6'],
                    ['#0ea5e9', '#22c55e'],
                    ['#ef4444', '#f97316'],
                ];
                const idx = hashCode(key) % palette.length;
                return palette[idx];
            }
            function genThumb(model) {
                const key = String(model.id || model.title);
                if (THUMB_CACHE.has(key)) return THUMB_CACHE.get(key);
                const c = document.createElement('canvas');
                c.width = 640;
                c.height = 480;
                const ctx = c.getContext('2d');
                const [c1, c2] = pickColors(key);
                const g = ctx.createLinearGradient(0, 0, 640, 480);
                g.addColorStop(0, c1);
                g.addColorStop(1, c2);
                ctx.fillStyle = g;
                ctx.fillRect(0, 0, 640, 480);
                ctx.fillStyle = 'rgba(255,255,255,.9)';
                ctx.font = 'bold 32px Pretendard, system-ui';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                const title = model.title || 'Untitled';
                const words = title.split(/\s+/);
                let lines = [],
                    cur = '';
                for (const w of words) {
                    const test = cur ? cur + ' ' + w : w;
                    if (ctx.measureText(test).width > 560) {
                        lines.push(cur);
                        cur = w;
                    } else {
                        cur = test;
                    }
                }
                if (cur) lines.push(cur);
                lines = lines.slice(0, 3);
                let y = 24;
                for (const ln of lines) {
                    ctx.fillText(ln, 24, y);
                    y += 38;
                }
                ctx.font = '16px Pretendard, system-ui';
                const d = model.description || '';
                const desc = d.length > 60 ? d.slice(0, 57) + 'â€¦' : d;
                if (desc) {
                    ctx.fillText(desc, 24, y + 6);
                }
                const url = c.toDataURL('image/png');
                THUMB_CACHE.set(key, url);
                return url;
            }

            function toEmbed(url) {
                try {
                    const last = url.split('/').pop();
                    const uid = (last || '').split('-').pop();
                    return `https://sketchfab.com/models/${uid}/embed?ui_theme=dark`;
                } catch (e) {
                    return url;
                }
            }

            async function loadModels() {
                try {
                    const res = await fetch('/api/models', {
                        credentials: 'include',
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data && Array.isArray(data.items)) {
                            MODELS = data.items.map((m) => ({
                                id: m.id,
                                title: m.title,
                                description: m.description,
                                url: m.url,
                                subject: m.subject,
                                thumb: m.thumb || null,
                            }));
                            return;
                        }
                    }
                } catch (e) {
                    console.warn('GET /api/models ì‹¤íŒ¨', e);
                }

                try {
                    const res = await fetch('models.json', {
                        cache: 'no-store',
                    });
                    if (res.ok) {
                        MODELS = await res.json();
                        if (Array.isArray(MODELS) && MODELS.length) return;
                    }
                } catch (e) {
                    console.warn('models.json ë¡œë“œ ì‹¤íŒ¨', e);
                }

                try {
                    const fallback = document.getElementById('models-json');
                    if (fallback) {
                        MODELS = JSON.parse(fallback.textContent || '[]');
                    }
                } catch (e) {
                    console.warn('inline JSON íŒŒì‹± ì‹¤íŒ¨', e);
                    MODELS = [];
                }
            }

            function openModal(title, url) {
                const modal = qs('#modal');
                const iframe = qs('#viewer');
                qs('#modalTitle').textContent = title || 'ë¯¸ë¦¬ë³´ê¸°';
                iframe.src = toEmbed(url);
                modal.classList.add('open');
                modal.focus();
                document.body.classList.add('no-scroll');
            }
            function closeModal() {
                const modal = qs('#modal');
                const iframe = qs('#viewer');
                modal.classList.remove('open');
                document.body.classList.remove('no-scroll');
                iframe.src = '';
            }

            function matchSubject(m, key) {
                if (m.subject && m.subject === key) return true;
                const text = (
                    m.title +
                    ' ' +
                    (m.description || '')
                ).toLowerCase();
                const kw = SUBJECTS[key].keywords;
                return kw.some((k) => text.includes(k.toLowerCase()));
            }

            function isBookmarked(id) {
                return state.bookmarks.has(Number(id));
            }

            function cardHTML(m) {
                const src = m.thumb || genThumb(m);
                const bg = src
                    ? ` style="background-image:url('${String(src).replace(
                          /'/g,
                          '%27'
                      )}')"`
                    : '';
                const label = src ? '' : `ì¸ë„¤ì¼ ${m.id}`;
                const bmActive = isBookmarked(m.id);
                return `
      <article class="item" data-id="${m.id}">
        <div class="thumb" data-id="${m.id}" data-title="${
                    m.title
                }" data-url="${m.url}"${bg}>
          ${label}
          <button class="bookmark-btn${
              bmActive ? ' active' : ''
          }" type="button" title="ë¶ë§ˆí¬" aria-label="ë¶ë§ˆí¬" data-bookmark="${
                    bmActive ? '1' : '0'
                }" style="display:none;">
            <i class='bx ${bmActive ? 'bxs-bookmark' : 'bx-bookmark'}'></i>
          </button>
          <button class="thumb-del" type="button" title="ì‚­ì œ" aria-label="ì‚­ì œ">Ã—</button>
        </div>
        <div class="meta">
          <div class="title">${m.title}</div>
          <div class="sub">${m.description || ''}</div>
        </div>
      </article>`;
            }

            /* ================== ğŸ‘ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ í•¨ìˆ˜ë“¤ ================== */

            // ğŸ‘ ì ìˆ˜ ì •ê·œí™” í•¨ìˆ˜ (0~1 ë²”ìœ„ë¡œ ë³€í™˜)
            function normalizeScores(results) {
                if (results.length === 0) return results;

                const scores = results.map((r) => r.score);
                const max = Math.max(...scores);
                const min = Math.min(...scores);

                if (max === min) {
                    return results.map((r) => ({ ...r, normScore: 1 }));
                }

                return results.map((r) => ({
                    ...r,
                    normScore: (r.score - min) / (max - min),
                }));
            }

            // ğŸ‘ AI ì˜ë¯¸ ê²€ìƒ‰ í˜¸ì¶œ
            async function fetchSemanticResults(query) {
                if (!query) return [];

                try {
                    const res = await fetch(
                        `/api/semantic_search?q=${encodeURIComponent(
                            query
                        )}&k=5`
                    );
                    const data = await res.json();

                    if (data.error || data.fallback) {
                        console.log('ğŸ‘ AI ê²€ìƒ‰ ì‚¬ìš© ë¶ˆê°€:', data.error);
                        return [];
                    }

                    // ğŸ‘ Score 0.5 ì´ìƒë§Œ í•„í„°ë§ (50% ì´ìƒ ìœ ì‚¬ë„)
                    return data.results
                        .filter((r) => r.score >= 0.35)
                        .map((r) => ({
                            id: r.id,
                            item: MODELS.find((m) => m.id === r.id) || r, // ë¡œì»¬ ë°ì´í„° ìš°ì„ 
                            score: r.score,
                            source: 'ai',
                        }));
                } catch (error) {
                    console.error('ğŸ‘ AI ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                    return [];
                }
            }

            // ğŸ‘ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ (ë¬¸ìì—´ + AI)
            async function hybridSearch(query) {
                // 1. ë¬¸ìì—´ ê²€ìƒ‰ (ê¸°ì¡´ ë°©ì‹)
                const localResults = MODELS.filter(
                    (m) =>
                        !query ||
                        (m.title + (m.description || ''))
                            .toLowerCase()
                            .includes(query.toLowerCase())
                ).map((m) => ({
                    id: m.id,
                    item: m,
                    score: 1.0, // ë¬¸ìì—´ ë§¤ì¹­ì€ ê¸°ë³¸ ì ìˆ˜ 1.0
                    source: 'text',
                }));

                // ì¿¼ë¦¬ê°€ ì—†ìœ¼ë©´ ë¬¸ìì—´ ê²€ìƒ‰ë§Œ ë°˜í™˜
                if (!query) {
                    return localResults.map((r) => r.item);
                }

                // ğŸ‘ AI ê²€ìƒ‰ì´ ë¹„í™œì„±í™”ë˜ë©´ ë¬¸ìì—´ ê²€ìƒ‰ë§Œ ë°˜í™˜
                if (!state.useAISearch) {
                    return localResults.map((r) => r.item);
                }

                // 2. AI ì˜ë¯¸ ê²€ìƒ‰
                const aiResults = await fetchSemanticResults(query);

                // AI ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë¬¸ìì—´ ê²€ìƒ‰ë§Œ ì‚¬ìš©
                if (aiResults.length === 0) {
                    return localResults.map((r) => r.item);
                }

                // 3. ğŸ‘ ì •ê·œí™” ì œê±° - ì›ë³¸ score ì‚¬ìš©
                // const normalizedAI = normalizeScores(aiResults); // ì‚­ì œë¨

                // 4. ë³‘í•© (ê°€ì¤‘ í‰ê· )
                const alpha = 0.65; // ğŸ‘ ë¬¸ìì—´ ê²€ìƒ‰ ê°€ì¤‘ì¹˜ (0.65 = 65%)
                const mergedMap = {};

                // ë¬¸ìì—´ ê²°ê³¼ ë¨¼ì € ì¶”ê°€
                for (const r of localResults) {
                    mergedMap[r.id] = {
                        item: r.item,
                        score: alpha * 1.0,
                        srcText: true,
                        srcAI: false,
                    };
                }

                // AI ê²°ê³¼ ë³‘í•© (ğŸ‘ ì›ë³¸ score ì‚¬ìš©)
                for (const r of aiResults) {
                    if (mergedMap[r.id]) {
                        // ì´ë¯¸ ë¬¸ìì—´ë¡œ ë‚˜ì˜¨ í•­ëª© - ì ìˆ˜ í•©ì‚°
                        mergedMap[r.id].score += (1 - alpha) * r.score; // ğŸ‘ r.normScore â†’ r.score
                        mergedMap[r.id].srcAI = true;
                    } else {
                        // AIì—ì„œë§Œ ë‚˜ì˜¨ í•­ëª©
                        mergedMap[r.id] = {
                            item: r.item,
                            score: (1 - alpha) * r.score, // ğŸ‘ r.normScore â†’ r.score
                            srcText: false,
                            srcAI: true,
                        };
                    }
                }

                // 5. ì ìˆ˜ ê¸°ì¤€ ì •ë ¬
                const finalResults = Object.values(mergedMap)
                    .sort((a, b) => b.score - a.score)
                    .map((r) => r.item);

                return finalResults;
            }

            // ğŸ‘ ë¹„ë™ê¸° ë Œë”ë§ì„ ìœ„í•œ í”Œë˜ê·¸
            let isSearching = false;

            async function render() {
                // ê²€ìƒ‰ ì¤‘ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
                if (isSearching && state.q) return;

                let list;

                // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ìˆ˜í–‰
                if (state.q) {
                    isSearching = true;
                    // ğŸ‘ AI ê²€ìƒ‰ ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¥¸ ë©”ì‹œì§€ í‘œì‹œ
                    qs('#count').textContent = state.useAISearch
                        ? 'ğŸ‘ AI ê²€ìƒ‰ ì¤‘...'
                        : 'ğŸ” ê²€ìƒ‰ ì¤‘...';

                    try {
                        list = await hybridSearch(state.q);
                    } catch (error) {
                        console.error(
                            'ğŸ‘ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ì‹¤íŒ¨, ê¸°ë³¸ ê²€ìƒ‰ ì‚¬ìš©:',
                            error
                        );
                        // í´ë°±: ê¸°ì¡´ ë¬¸ìì—´ ê²€ìƒ‰ë§Œ ì‚¬ìš©
                        list = MODELS.filter((m) =>
                            (m.title + (m.description || ''))
                                .toLowerCase()
                                .includes(state.q.toLowerCase())
                        );
                    } finally {
                        isSearching = false;
                    }
                } else {
                    // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ì „ì²´ ëª©ë¡
                    list = MODELS;
                }

                // ê³¼ëª© í•„í„° ì ìš©
                list = list.filter(
                    (m) => !state.subject || matchSubject(m, state.subject)
                );

                const total = list.length;
                const pages = Math.max(1, Math.ceil(total / state.per));
                state.page = Math.min(state.page, pages);
                const start = (state.page - 1) * state.per;
                const pageItems = list.slice(start, start + state.per);

                // ğŸ‘ ê²€ìƒ‰ ëª¨ë“œì— ë”°ë¥¸ ê²°ê³¼ í‘œì‹œ
                const searchMode =
                    state.q && state.useAISearch ? ' (AI ê²€ìƒ‰)' : '';
                qs('#count').textContent = `${total}ê°œ ê²°ê³¼${searchMode}`;
                qs('#results').innerHTML = pageItems.map(cardHTML).join('');

                // ì¸ë„¤ì¼ í´ë¦­ â†’ ë¯¸ë¦¬ë³´ê¸° (â˜… ë¶ë§ˆí¬ ë²„íŠ¼ í´ë¦­ì€ ë¬´ì‹œ)
                qsa('.thumb').forEach((el) =>
                    el.addEventListener('click', (e) => {
                        if (e.target.closest('.bookmark-btn')) return; // ê°€ë“œ
                        openModal(el.dataset.title, el.dataset.url);
                    })
                );

                // (ë©”ì¸í˜ì´ì§€) ì‚­ì œ ë²„íŠ¼ ë¬´ë ¥í™”
                qsa('.thumb-del').forEach((btn) => {
                    btn.style.display = 'none';
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        return false;
                    };
                });

                // â˜… ë¶ë§ˆí¬ ë²„íŠ¼ ë³´ì´ê¸°/ë™ì‘(ë¡œê·¸ì¸ì‹œì—ë§Œ)
                qsa('.bookmark-btn').forEach((btn) => {
                    if (state.isLoggedIn) {
                        btn.style.display = 'inline-grid';
                    } else {
                        btn.style.display = 'none';
                    }
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation(); // ì „íŒŒ ì°¨ë‹¨
                        e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨

                        const card = btn.closest('.item');
                        const id = Number(card?.dataset?.id);
                        if (!id) return;

                        if (isBookmarked(id)) {
                            try {
                                const res = await fetch(
                                    `/api/bookmarks/${id}`,
                                    {
                                        method: 'DELETE',
                                        credentials: 'include',
                                    }
                                );
                                if (res.status === 401) {
                                    openLoginModal();
                                    return;
                                }
                                if (!res.ok) {
                                    throw new Error('BOOKMARK_DELETE_FAILED');
                                }
                                state.bookmarks.delete(id);
                                btn.classList.remove('active');
                                btn.dataset.bookmark = '0';
                                btn.querySelector('i').className =
                                    'bx bx-bookmark';
                                showToast('ë¶ë§ˆí¬ì—ì„œ ì œê±°ë¨ âŒ', '#e63946');
                            } catch (err) {
                                alert(
                                    'ë¶ë§ˆí¬ í•´ì œ ì‹¤íŒ¨: ' +
                                        (err.message || 'UNKNOWN')
                                );
                            }
                        } else {
                            try {
                                const res = await fetch('/api/bookmarks', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    credentials: 'include',
                                    body: JSON.stringify({ modelId: id }),
                                });
                                if (res.status === 401) {
                                    openLoginModal();
                                    return;
                                }
                                if (!res.ok) {
                                    throw new Error('BOOKMARK_POST_FAILED');
                                }
                                state.bookmarks.add(id);
                                btn.classList.add('active');
                                btn.dataset.bookmark = '1';
                                btn.querySelector('i').className =
                                    'bx bxs-bookmark';
                                showToast('ë¶ë§ˆí¬ì— ì¶”ê°€ë¨ âœ…');
                            } catch (err) {
                                alert(
                                    'ë¶ë§ˆí¬ ì‹¤íŒ¨: ' + (err.message || 'UNKNOWN')
                                );
                            }
                        }
                    });
                });

                // í˜ì´ì €
                const pager = qs('#pager');
                pager.innerHTML = Array.from({ length: pages })
                    .map(
                        (_, i) =>
                            `<button ${
                                i + 1 === state.page
                                    ? 'class="btn primary"'
                                    : 'class="btn"'
                            } data-page="${i + 1}">${i + 1}</button>`
                    )
                    .join('');
                qsa('#pager [data-page]').forEach((b) =>
                    b.addEventListener('click', async () => {
                        state.page = +b.dataset.page;
                        await render(); // ğŸ‘ async ì²˜ë¦¬
                    })
                );
            }

            // ğŸ‘ ê²€ìƒ‰ (async ì²˜ë¦¬)
            qs('#btnSearch').addEventListener('click', async () => {
                state.q = qs('#q').value.trim();
                state.page = 1;
                await render();
            });
            qs('#q').addEventListener('keydown', async (e) => {
                if (e.key === 'Enter') {
                    state.q = qs('#q').value.trim();
                    state.page = 1;
                    await render();
                }
            });

            // ğŸ‘ AI ê²€ìƒ‰ í† ê¸€ ìŠ¤ìœ„ì¹˜ ì´ë²¤íŠ¸
            qs('#aiSearchToggle').addEventListener('change', async (e) => {
                state.useAISearch = e.target.checked;
                // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì¬ê²€ìƒ‰
                if (state.q) {
                    state.page = 1;
                    await render();
                }
                // í† ê¸€ ìƒíƒœë¥¼ localStorageì— ì €ì¥
                localStorage.setItem(
                    'useAISearch',
                    state.useAISearch ? 'true' : 'false'
                );
            });

            // ğŸ‘ ê³¼ëª© ë‹¨ì¼ ì„ íƒ (async ì²˜ë¦¬)
            qsa('.subject-chk').forEach((chk) => {
                chk.addEventListener('change', async () => {
                    if (chk.checked) {
                        qsa('.subject-chk').forEach((other) => {
                            if (other !== chk) other.checked = false;
                        });
                        state.subject = chk.value;
                    } else {
                        state.subject = null;
                    }
                    state.page = 1;
                    await render();
                });
            });
            qs('#btnClear').addEventListener('click', async () => {
                qsa('.subject-chk').forEach((c) => (c.checked = false));
                state.subject = null;
                state.page = 1;
                await render();
            });

            // ë·°ì–´ ëª¨ë‹¬ ë‹«ê¸°
            qs('#btnClose').addEventListener('click', closeModal);
            qs('#modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeModal();
            });
            document.addEventListener(
                'keydown',
                (e) => {
                    if (e.key === 'Escape') closeModal();
                },
                true
            );

            // ===== Login UI interactions =====
            const signup = document.getElementById('sign-up');
            const signin = document.getElementById('sign-in');
            const loginin = document.getElementById('login-in');
            const loginup = document.getElementById('login-up');
            signup &&
                signup.addEventListener('click', () => {
                    loginin.classList.remove('block');
                    loginup.classList.remove('none');
                    loginin.classList.add('none');
                    loginup.classList.add('block');
                });
            signin &&
                signin.addEventListener('click', () => {
                    loginin.classList.remove('none');
                    loginup.classList.remove('block');
                    loginin.classList.add('block');
                    loginup.classList.add('none');
                });

            // API ë˜í¼
            async function api(path, method = 'GET', body) {
                const res = await fetch(path, {
                    method,
                    headers:
                        body instanceof FormData
                            ? undefined
                            : { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: body
                        ? body instanceof FormData
                            ? body
                            : JSON.stringify(body)
                        : undefined,
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok)
                    throw Object.assign(new Error(data.error || 'ìš”ì²­ ì‹¤íŒ¨'), {
                        status: res.status,
                        data,
                    });
                return data;
            }

            // â˜… ë‚´ ë¶ë§ˆí¬ ë¶ˆëŸ¬ì˜¤ê¸°
            async function loadMyBookmarks() {
                state.bookmarks.clear();
                try {
                    // í™•ì¥ ì‘ë‹µ(ê°ì²´ ë°°ì—´)ì„ ì›í•˜ë©´ ?expand=1 ì‚¬ìš© ê°€ëŠ¥. ì—¬ê¸°ì„œëŠ” id ì„¸íŠ¸ë§Œ ì¨ë„ ì¶©ë¶„
                    const res = await fetch('/api/bookmarks', {
                        credentials: 'include',
                    });
                    if (!res.ok) return;
                    const data = await res.json().catch(() => ({}));
                    const ids = Array.isArray(data?.items)
                        ? data.items
                        : Array.isArray(data)
                        ? data
                        : [];
                    ids.forEach((id) => state.bookmarks.add(Number(id)));
                } catch (e) {
                    console.warn('loadMyBookmarks fail', e);
                }
            }

            async function refreshAuthUI() {
                try {
                    const me = await api('/api/auth/whoami');
                    // ë©”ì¸ì—ì„œëŠ” 'admin'ì„ ë¡œê·¸ì¸ìœ¼ë¡œ ì·¨ê¸‰í•˜ì§€ ì•ŠìŒ
                    if (me && me.user && me.user.role !== 'admin') {
                        state.isLoggedIn = true;
                        state.user = me.user;
                        state.currentUser = me.user; // ğŸ ì±—ë´‡ ë²„íŠ¼ í‘œì‹œìš©
                        await loadMyBookmarks();
                    } else {
                        state.isLoggedIn = false;
                        state.user = null;
                        state.currentUser = null; // ğŸ ì±—ë´‡ ë²„íŠ¼ ìˆ¨ê¹€ìš©
                        state.bookmarks.clear();
                    }
                } catch {
                    state.isLoggedIn = false;
                    state.user = null;
                    state.currentUser = null; // ğŸ ì±—ë´‡ ë²„íŠ¼ ìˆ¨ê¹€ìš©
                    state.bookmarks.clear();
                }

                const btnAuth = document.getElementById('btnAuth');
                const btnLogout = document.getElementById('btnLogout');

                if (state.isLoggedIn) {
                    btnAuth.textContent = 'ë§ˆì´í˜ì´ì§€';
                    btnLogout.style.display = 'inline-flex';
                } else {
                    btnAuth.textContent = 'ë¡œê·¸ì¸';
                    btnLogout.style.display = 'none';
                }

                // ğŸ ì±—ë´‡ ë²„íŠ¼ í‘œì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                if (typeof updateChatbotVisibility === 'function') {
                    updateChatbotVisibility();
                }

                await render(); // ğŸ‘ ìƒíƒœ ë°˜ì˜(ë¶ë§ˆí¬ ì•„ì´ì½˜ë„ ë°˜ì˜)
            }

            // ë¡œê·¸ì¸/ë§ˆì´í˜ì´ì§€ ì´ë™
            document
                .getElementById('btnAuth')
                .addEventListener('click', (e) => {
                    e.preventDefault();
                    if (state.isLoggedIn) {
                        window.location.href = '/mypage.html';
                    } else {
                        openLoginModal();
                    }
                });

            // ë¡œê·¸ì•„ì›ƒ (í—¤ë”)
            document
                .getElementById('btnLogout')
                .addEventListener('click', async () => {
                    try {
                        await api('/api/auth/logout', 'POST');
                    } catch (e) {
                        console.warn('logout error', e);
                    }
                    state.isLoggedIn = false;
                    state.user = null;
                    state.bookmarks.clear();
                    ['#modalLogin', '#modalMypage', '#modal'].forEach((sel) =>
                        qs(sel)?.classList.remove('open')
                    );
                    document.body.classList.remove('no-scroll');
                    await refreshAuthUI();
                });

            // ë§ˆì´í˜ì´ì§€ ì•ˆì˜ ë¡œê·¸ì•„ì›ƒ
            document
                .getElementById('btnMypageLogout')
                .addEventListener('click', async () => {
                    try {
                        await api('/api/auth/logout', 'POST');
                    } catch {}
                    state.isLoggedIn = false;
                    state.user = null;
                    state.bookmarks.clear();
                    qs('#modalMypage').classList.remove('open');
                    document.body.classList.remove('no-scroll');
                    await refreshAuthUI();
                });
            // ë§ˆì´í˜ì´ì§€ ë‹«ê¸°
            document
                .getElementById('btnCloseMypage')
                .addEventListener('click', () => {
                    qs('#modalMypage').classList.remove('open');
                    document.body.classList.remove('no-scroll');
                });
            qs('#modalMypage').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    qs('#modalMypage').classList.remove('open');
                    document.body.classList.remove('no-scroll');
                }
            });

            // Sign In (ë©”ì¸: ê´€ë¦¬ì ì°¨ë‹¨)
            document
                .getElementById('login-in')
                .addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = (
                        document.getElementById('loginUsername').value || ''
                    ).trim();
                    const pw = (
                        document.getElementById('loginPw').value || ''
                    ).trim();
                    try {
                        await api('/api/auth/login', 'POST', {
                            username,
                            password: pw,
                        });
                        try {
                            const me = await api('/api/auth/whoami');
                            if (me?.user?.role === 'admin') {
                                await api('/api/auth/logout', 'POST');
                                return;
                            }
                        } catch {}
                        await refreshAuthUI();
                        const m = qs('#modalLogin');
                        m.classList.remove('open');
                        document.body.classList.remove('no-scroll');
                    } catch (err) {
                        alert(err.data?.error || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
                    }
                });

            // Sign Up
            document
                .getElementById('login-up')
                ?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document
                        .getElementById('signupUsername')
                        ?.value?.trim();
                    const email = document
                        .getElementById('signupEmail')
                        ?.value?.trim();
                    const pw = document
                        .getElementById('signupPw')
                        ?.value?.trim();
                    if (!username || !pw) {
                        alert('Username/PasswordëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
                        return;
                    }
                    if (username.toLowerCase() === 'admin') {
                        alert('ì´ ì‚¬ìš©ìëª…ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    try {
                        await api('/api/auth/signup', 'POST', {
                            username,
                            email,
                            password: pw,
                        });
                        (document.getElementById('sign-in') || {}).click?.();
                        alert('ê°€ì… ì™„ë£Œ! ì´ì œ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                    } catch (err) {
                        alert(err.data?.error || 'ê°€ì… ì‹¤íŒ¨');
                    }
                });

            // ğŸ ============ ì±—ë´‡ ê¸°ëŠ¥ ============
            const chatbotBtn = qs('#chatbotBtn');
            const chatModal = qs('#chatModal');
            const closeChatBtn = qs('#closeChatBtn');
            const chatMessages = qs('#chatMessages');
            const chatInput = qs('#chatInput');
            const sendChatBtn = qs('#sendChatBtn');
            const chatSubject = qs('#chatSubject');

            // ğŸ ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ì±—ë´‡ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            function updateChatbotVisibility() {
                if (chatbotBtn) {
                    chatbotBtn.style.display = state.currentUser
                        ? 'flex'
                        : 'none';
                }
            }

            // ğŸ ì±—ë´‡ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
            if (chatbotBtn) {
                chatbotBtn.addEventListener('click', () => {
                    console.log('ì±—ë´‡ ë²„íŠ¼ í´ë¦­ë¨!'); // ë””ë²„ê¹…ìš©
                    chatModal.classList.add('open');
                    chatInput?.focus();
                });
            }
            if (closeChatBtn) {
                closeChatBtn.addEventListener('click', () => {
                    chatModal.classList.remove('open');
                });
            }

            // ğŸ ë©”ì‹œì§€ ë Œë”ë§
            function addChatMessage(role, content) {
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-message ${role}`;

                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = content;
                msgDiv.appendChild(í’ì„ ê»Œ);

                // ğŸ AI ë‹µë³€ì¸ ê²½ìš° 'ë…¸íŠ¸ì— ì €ì¥' ë²„íŠ¼ ì¶”ê°€
                if (role === 'assistant') {
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'save-note-btn';
                    saveBtn.textContent = 'ğŸ“ ë…¸íŠ¸ì— ì €ì¥';
                    saveBtn.onclick = async () => {
                        const title = prompt(
                            'ë…¸íŠ¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:',
                            chatSubject.value + ' í•™ìŠµ ë‚´ìš©'
                        );
                        if (!title) return;
                        try {
                            await api('/api/notes', 'POST', {
                                title,
                                content,
                                subject: chatSubject.value,
                            });
                            showToast('ë…¸íŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        } catch (err) {
                            alert(err.data?.error || 'ì €ì¥ ì‹¤íŒ¨');
                        }
                    };
                    msgDiv.appendChild(saveBtn);
                }

                chatMessages.appendChild(msgDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // ğŸ ì±—ë´‡ ë©”ì‹œì§€ ì „ì†¡
            async function sendChatMessage(withQuiz = false) {
                const message = chatInput.value.trim();
                if (!message) return;

                const subject = chatSubject.value;

                // ğŸ ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
                addChatMessage('user', message);
                chatInput.value = '';

                // ğŸ ë¡œë”© í‘œì‹œ
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'chat-message assistant';
                loadingDiv.innerHTML =
                    '<div class="message-bubble">ë‹µë³€ ìƒì„± ì¤‘...</div>';
                loadingDiv.id = 'loading-message';
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                try {
                    const res = await api('/api/chat', 'POST', {
                        message,
                        subject,
                        withQuiz,
                    });

                    // ğŸ ë¡œë”© ì œê±°
                    loadingDiv.remove();

                    // ğŸ AI ë‹µë³€ í‘œì‹œ
                    addChatMessage('assistant', res.answer);
                } catch (err) {
                    loadingDiv.remove();
                    addChatMessage(
                        'assistant',
                        'ì˜¤ë¥˜: ' + (err.data?.error || 'ë‹µë³€ ìƒì„± ì‹¤íŒ¨')
                    );
                }
            }

            // ğŸ ì „ì†¡ ë²„íŠ¼ í´ë¦­
            if (sendChatBtn) {
                sendChatBtn.addEventListener('click', () =>
                    sendChatMessage(false)
                );
            }

            // ğŸ Enter í‚¤ë¡œ ì „ì†¡
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage(false);
                    }
                });
            }

            // ğŸ í€´ì¦ˆ ìš”ì²­ ë²„íŠ¼
            const quizBtn = qs('#quizBtn');
            if (quizBtn) {
                quizBtn.addEventListener('click', () => {
                    chatInput.value = 'ì´ ì£¼ì œì— ëŒ€í•œ í€´ì¦ˆ 3ë¬¸ì œë¥¼ ë‚´ì£¼ì„¸ìš”.';
                    sendChatMessage(true);
                });
            }

            // ì‹œì‘
            document.getElementById('year').textContent =
                new Date().getFullYear();
            (async () => {
                // ğŸ‘ ì €ì¥ëœ AI ê²€ìƒ‰ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
                const savedAISearch = localStorage.getItem('useAISearch');
                if (savedAISearch !== null) {
                    state.useAISearch = savedAISearch === 'true';
                    qs('#aiSearchToggle').checked = state.useAISearch;
                }

                await refreshAuthUI();
                await loadModels();
                await render(); // ğŸ‘ async ì²˜ë¦¬
            })();
            // ESCë¡œ ë¡œê·¸ì¸ ëª¨ë‹¬ ë‹«ê¸°
            document.addEventListener(
                'keydown',
                (e) => {
                    if (
                        e.key === 'Escape' &&
                        document
                            .querySelector('#modalLogin')
                            ?.classList.contains('open')
                    ) {
                        closeLoginModal();
                    }
                },
                true
            );

            // ë‚´ìš© ë°”ê¹¥ í´ë¦­ ì‹œ ë¡œê·¸ì¸ ëª¨ë‹¬ ë‹«ê¸°
            document
                .getElementById('modalLogin')
                ?.addEventListener('click', (e) => {
                    const content = document.querySelector(
                        '#modalLogin .login__content'
                    );
                    if (!content) return;
                    if (!content.contains(e.target)) {
                        closeLoginModal();
                    }
                });
        </script>
    </body>
</html>
