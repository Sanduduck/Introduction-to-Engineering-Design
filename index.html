<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>공설입 – 홈씨어터</title>
  <meta name="description" content="백엔드 없이 GitHub Pages에서 바로 동작하는 홈씨어터 갤러리·옵션·빌더 단일 파일 SPA(5060 친화 브라운 테마)." />
  <style>
    :root{
      /* 5060 친화 브라운 팔레트 */
      --bg:#F5F1EB;         /* Ivory White */
      --ink:#3A2E25;        /* 본문 텍스트 */
      --muted:#8A7E6E;      /* 보조 텍스트 */
      --accent:#B66A3D;     /* Copper Accent */
      --surface:#FFFFFF;    /* 카드 배경 */
      --surface-2:#E6DCCE;  /* 연한 크림 */
      --border:#E0D6C9;     
      --chip:#F3EEE7;       
      --danger:#8b2e2e;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif;color:var(--ink);background:var(--bg)}
    a{text-decoration:none;color:inherit}

    /* 헤더 */
    header.site{position:sticky;top:0;z-index:20;background:rgba(245,241,235,.8);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:0 16px}
    .row{display:flex;align-items:center;}
    header .row{height:56px;justify-content:space-between}
    .logo{display:flex;align-items:center;gap:10px}
    .logo-b{width:28px;height:28px;background:var(--accent);border-radius:6px}
    nav.primary{display:flex;gap:8px}
    nav.primary a{padding:8px 12px;border-radius:10px}
    nav.primary a.active{background:var(--surface-2)}

    /* 히어로 */
    section.hero{background:var(--surface-2);border-bottom:1px solid var(--border)}
    .hero h1{margin:0;padding:18px 0 6px;font-size:28px}
    .cta-bar{display:flex;flex-wrap:wrap;gap:8px;padding:8px 0 18px}
    .btn{padding:9px 12px;border-radius:10px;font-size:14px;border:1px solid var(--border);background:var(--surface);cursor:pointer}
    .btn:hover{filter:brightness(0.98)}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
    .btn.ghost{background:transparent;border-color:transparent}

    /* 필터바 (갤러리) */
    aside.filters{position:sticky;top:56px;z-index:9;background:var(--bg);border-bottom:1px solid var(--border)}
    form.filters{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:12px 0}
    @media(min-width:900px){form.filters{grid-template-columns:repeat(7,1fr)}}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field select,.field input[type="number"],.field input[type="text"]{width:100%;padding:10px 8px;border-radius:8px;border:1px solid var(--border);background:var(--surface);font-size:14px}

    /* 카드 그리드 */
    section.gallery{padding:18px 0}
    ul.card-grid{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    @media(min-width:900px){ul.card-grid{grid-template-columns:repeat(4,1fr)}}
    article.card{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:var(--surface);transition:box-shadow .15s}
    article.card:hover{box-shadow:0 4px 18px rgba(0,0,0,.05)}
    .thumb{aspect-ratio:4/3;background:#EDE6DD;display:grid;place-items:center;font-size:46px}
    .card-body{padding:12px}
    .card-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .title{font-size:14px;font-weight:700;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .meta{margin-top:4px;color:var(--muted);font-size:12px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .tags{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .tag{background:var(--chip);color:#5a5147;border-radius:999px;padding:5px 10px;font-size:12px}
    .actions{display:flex;gap:6px;margin-top:10px}
    .chip-btn{border:1px solid var(--border);background:var(--surface);border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .chip-btn.on{background:#EED7C7;border-color:#E6C7B1}

    .more{display:grid;place-items:center;padding:10px 0 24px}

    /* 빌더 */
    section.builder{padding:18px 0}
    .grid-2{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:980px){.grid-2{grid-template-columns:1.2fr .8fr}}
    .panel{border:1px solid var(--border);border-radius:14px;background:var(--surface)}
    .panel h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:16px}
    .panel .body{padding:12px 14px}
    .builder-canvas{height:360px;border:1px dashed var(--border);border-radius:12px;background:#F1EAE2;position:relative;overflow:hidden}
    .ghost-guide{position:absolute;left:50%;top:6%;transform:translateX(-50%);width:35%;height:6px;background:rgba(182,106,61,.3);border-radius:4px}
    .seat-guide{position:absolute;left:50%;bottom:18%;transform:translateX(-50%);width:18%;height:4px;background:rgba(138,126,110,.35);border-radius:4px}
    .item{position:absolute;left:0;top:0;transform:translate(-50%,-50%);user-select:none;cursor:grab}
    .item .dot{width:28px;height:28px;display:grid;place-items:center;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 1px 0 rgba(0,0,0,.04)}
    .kv{display:flex;justify-content:space-between;font-size:14px;margin:6px 0}
    .small{font-size:12px;color:var(--muted)}

    /* 옵션 페이지 */
    section.options{padding:18px 0}
    .options-grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:980px){.options-grid{grid-template-columns:1fr 1fr}}
    .opt-card{border:1px solid var(--border);border-radius:14px;background:var(--surface);overflow:hidden}
    .opt-card h4{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:15px}
    .opt-body{padding:12px;display:grid;gap:10px}
    .opt-line{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center}
    .opt-line input[type="checkbox"]{transform:scale(1.1)}

    .qty{display:inline-grid;grid-template-columns:auto 42px auto;gap:6px;align-items:center}
    .qty button{border:1px solid var(--border);background:var(--surface);border-radius:10px;padding:6px 10px;cursor:pointer}
    .qty input{width:42px;padding:6px 8px;border:1px solid var(--border);border-radius:8px;text-align:center}

    .basket{position:sticky;bottom:0;z-index:15;background:rgba(245,241,235,.92);backdrop-filter:blur(6px);border-top:1px solid var(--border)}
    .basket .wrap{display:flex;justify-content:space-between;align-items:center;padding:10px 16px}
    .basket .sum{font-weight:700}

    footer.site{border-top:1px solid var(--border);color:var(--muted);font-size:14px}
    footer .wrap{padding:24px 16px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:var(--ink);color:#fff;padding:8px 10px;border-radius:8px}
    .hide{display:none}

    /* 접근성/모션 */
    @media (prefers-reduced-motion: reduce){.btn:hover{filter:none} html{scroll-behavior:auto}}
  </style>
</head>
<body>
  <a href="#main" class="sr-only" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden">본문으로 건너뛰기</a>

  <header class="site" role="banner">
    <div class="wrap row">
      <div class="logo"><div class="logo-b" aria-hidden="true"></div><strong>공설입 – 홈씨어터</strong></div>
      <nav class="primary" aria-label="주요">
        <a href="#/gallery" id="navGallery">갤러리</a>
        <a href="#/options" id="navOptions">옵션</a>
        <a href="#/builder" id="navBuilder">빌더</a>
      </nav>

    </div>
  </header>

  <section class="hero" aria-labelledby="hero-title">
    <div class="wrap">
      <h1 id="hero-title">공설입 제출용 홈씨어터 사이트</h1>
      <div class="cta-bar" role="group" aria-label="주요 작업">
        <button id="btnShareView" class="btn" type="button" title="현재 보기 공유">현재 보기 공유</button>
        <button class="btn ghost" type="button" id="btnAbout">서비스 알아보기</button>
        <button class="btn primary" type="button" id="btnToBuilder">빌더로 이동</button>
      </div>
    </div>
  </section>

  <!-- 갤러리 섹션 -->
  <aside class="filters" role="region" aria-label="필터">
    <div class="wrap">
      <form id="filterForm" class="filters" role="search">
        <div class="field"><label for="fSort">정렬</label><select id="fSort" name="sort"><option>전체</option><option>최신순</option><option>평점순</option></select></div>
        <div class="field"><label for="fType">주거형태</label><select id="fType" name="type"><option>전체</option><option>아파트</option><option>빌라</option><option>원룸</option><option>오피스텔</option><option>주택</option></select></div>
        <div class="field"><label for="fArea">전용면적</label><select id="fArea" name="area"><option>전체</option><option>~10평</option><option>10~20평</option><option>20~30평</option><option>30평~</option></select></div>
        <div class="field"><label for="fRooms">방 개수</label><select id="fRooms" name="rooms"><option>전체</option><option>1</option><option>2</option><option>3+</option></select></div>
        <div class="field"><label for="fBays">베이 수</label><select id="fBays" name="bays"><option>전체</option><option>1</option><option>2</option><option>3+</option></select></div>
        <div class="field"><label for="fFamily">가족형태</label><select id="fFamily" name="family"><option>전체</option><option>1인</option><option>부부</option><option>아이동반</option><option>반려동물</option></select></div>
        <div class="field"><label for="fStyle">스타일</label><select id="fStyle" name="style"><option>전체</option><option>모던</option><option>미니멀</option><option>내추럴</option><option>빈티지</option><option>북유럽</option></select></div>
      </form>
    </div>
  </aside>

  <main id="main">
    <!-- GALLERY -->
    <section id="page-gallery" class="gallery" aria-labelledby="gallery-title">
      <div class="wrap">
        <h2 id="gallery-title" class="sr-only" style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden">갤러리</h2>
        <ul id="grid" class="card-grid" role="list"></ul>
        <div class="more"><button id="btnMore" class="btn" type="button">더보기</button></div>
      </div>
    </section>

    <!-- OPTIONS -->
    <section id="page-options" class="options" aria-labelledby="options-title" hidden>
      <div class="wrap">
        <h2 id="options-title" style="margin:0 0 10px 0">옵션 선택</h2>
        <p class="small">배민 마라탕 옵션처럼 **수량**과 **필수 선택**을 지원합니다. 선택은 아래 장바구니에 모이고, 빌더로 이동해 배치/견적에 반영됩니다.</p>
        <div id="optionsGrid" class="options-grid"></div>
        <div style="margin-top:12px" class="actions">
          <button id="btnOptionsClear" class="btn" type="button">옵션 선택 초기화</button>
        </div>
      </div>
      <!-- 하단 장바구니 바 -->
      <div class="basket" aria-label="옵션 장바구니">
        <div class="wrap">
          <div>
            <div class="small">선택 항목 <span id="basketCount">0</span>개</div>
            <div class="sum" id="basketSum">0 원</div>
          </div>
          <div>
            <button id="btnOptionsToBuilder" class="btn primary" type="button">담기 · 빌더로</button>
          </div>
        </div>
      </div>
    </section>

    <!-- BUILDER -->
    <section id="page-builder" class="builder" aria-labelledby="builder-title" hidden>
      <div class="wrap">
        <h2 id="builder-title" style="margin:0 0 10px 0">나만의 홈씨어터 빌더</h2>
        <div class="grid-2">
          <!-- 좌: 캔버스 -->
          <section class="panel" aria-label="배치">
            <h3>배치</h3>
            <div class="body">
              <div id="canvas" class="builder-canvas" aria-label="방 배치 캔버스">
                <div class="ghost-guide" title="스크린 가이드"></div>
                <div class="seat-guide" title="좌석 가이드"></div>
              </div>
              <p class="small">아이템을 캔버스에서 드래그해 배치하세요. (좌표 자동 저장)</p>
            </div>
          </section>
          <!-- 우: 선택/요약 -->
          <aside class="panel" aria-label="선택 항목">
            <h3>선택 항목</h3>
            <div class="body" id="selectedList"></div>
            <div class="body" id="summaryBox">
              <div class="kv"><span>총 가격</span><strong id="sumPrice">0 원</strong></div>
              <div class="kv"><span>예상 소비전력</span><strong id="sumPower">0 W</strong></div>
              <div class="kv"><span>예상 소음(평균)</span><strong id="sumNoise">0 dB</strong></div>
              <div class="kv"><span>추천 시청 거리</span><strong id="sumView">2.5 m</strong></div>
              <div class="actions" style="margin-top:12px">
                <button id="btnShareBuild" class="btn" type="button">설계 공유</button>
                <button id="btnClear" class="btn" type="button">초기화</button>
              </div>
            </div>
            <div class="body">
              <div class="kv" style="margin-top:8px"><span class="small">북마크 불러오기</span></div>
              <div id="bookmarksBox" class="small">(북마크가 없습니다)</div>
            </div>
          </aside>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast hide" role="status" aria-live="polite"></div>

  <footer class="site" role="contentinfo">
  </footer>

  <script>
  // ===================== 더미 데이터(갤러리) =====================
  const DEMO = [
    mk({ id: "p1", title: "시네마 거실 24평", thumb: "🎬", type: "아파트", area: "20~30평", rooms: "3+", bays: "3+", family: "부부", style: "모던", tags: ["홈씨어터","암막","사운드바"], pop: 99, rating: 4.8, ts: 1728000000000 }),
    mk({ id: "p2", title: "북유럽 원룸 10평", thumb: "🛋️", type: "원룸", area: "~10평", rooms: "1", bays: "1", family: "1인", style: "북유럽", tags: ["우드","조명"], pop: 76, rating: 4.5, ts: 1723000000000 }),
    mk({ id: "p3", title: "빌라 내추럴 18평", thumb: "🌿", type: "빌라", area: "10~20평", rooms: "2", bays: "2", family: "부부", style: "내추럴", tags: ["패브릭","그린"], pop: 65, rating: 4.2, ts: 1721000000000 }),
    ...Array.from({length:36}).map((_,i)=> mk({ id: `m${i}`, title: `아파트 25평 데모 ${i+1}`, thumb: i%3?"🏡":"🏠", type: "아파트", area: "20~30평", rooms: "3+", bays: (i%2?"2":"3+"), family: (i%3?"부부":"아이동반"), style: (i%2?"모던":"내추럴"), tags:["화이트","우드"], pop: 50+(i%40), rating: 3.5+(i%5)*0.2, ts: 1710000000000 + i*10000000 }))
  ];
  function mk(o){ return Object.assign({tags:[],pop:0,rating:0,ts:Date.now()}, o); }

  // ===================== 옵션 데이터 =====================
  const OPTIONS = [
    { id:'base-projector', icon:'🎞️', name:'기본 프로젝터(필수 선택)', base:{price:590000, power:160, noise:28}, required:true,
      desc:'필수 베이스. 초단초점과는 별도 선택 가능.', params:[{key:'base-res',label:'해상도',type:'select',options:['FHD','4K']}]},

    { id:'ust-projector', icon:'📽️', name:'초단초점 프로젝터', base:{price:1890000, power:220, noise:24},
      desc:'벽 밀착 설치, 그림자 최소화', params:[{key:'resolution',label:'해상도',type:'select',options:['FHD','4K']},{key:'speaker',label:'스피커 성능',type:'select',options:['표준','프리미엄']}] },

    { id:'ai-light', icon:'💡', name:'AI 조명 시스템', base:{price:300000, power:18, noise:0},
      desc:'영상/장면에 맞춰 밝기·색온도 자동 조절', params:[{key:'mode', label:'연출 모드', type:'select', options:['영화','스포츠','음악','수면']}], qtyMax:4, unit:'세트' },

    { id:'motor-curtain', icon:'🪟', name:'전동 암막커튼', base:{price:400000, power:8, noise:25},
      desc:'자동 열·닫힘(차광 90% 권장)', params:[{key:'opacity',label:'차광',type:'select',options:['80%','90%','100%']}], qtyMax:2, unit:'세트' },

    { id:'smart-table', icon:'🍔', name:'스마트 배달 테이블', base:{price:450000, power:15, noise:10},
      desc:'테이블 내장 태블릿OS', params:[{key:'os',label:'OS',type:'select',options:['Android','Linux']}], qtyMax:4, unit:'대' },

    { id:'fiber-ceiling', icon:'✨', name:'천장 광섬유 조명', base:{price:380000, power:12, noise:0},
      desc:'은은한 별빛으로 명암비 향상', qtyMax:3, unit:'세트' },

    { id:'haptic-chair', icon:'🪑', name:'멀티감각 체험 의자', base:{price:1200000, power:60, noise:30},
      desc:'향기/온도/진동 연동', qtyMax:4, unit:'좌석' },

    { id:'auto-side-table', icon:'🧑‍💻', name:'AI 테이블(자동 이동)', base:{price:250000, power:10, noise:20},
      desc:'손동작 인식으로 사용자에게 이동', params:[{key:'speed',label:'속도',type:'select',options:['느림','보통','빠름']}], qtyMax:2, unit:'대', safety:'충돌 방지 센서 필요(데모)' },

    { id:'vr-ar-avatar', icon:'🧑‍🤝‍🧑', name:'VR-AR 동시 시청(아바타)', base:{price:0, power:0, noise:0},
      desc:'VR 헤드셋 필요(데모 UI)', params:[{key:'presence',label:'존재감',type:'select',options:['라이트','표준','몰입']}] },

    { id:'ai-assistant', icon:'🎙️', name:'AI 대화형 어시스턴트', base:{price:0, power:0, noise:0},
      desc:'배우/촬영지 등 음성 Q&A(데모)', params:[{key:'wake',label:'호출어',type:'text',placeholder:'예: 시네마야'}] },

    { id:'ai-replay', icon:'🧠', name:'AI 감정 스토리보드 리플레이', base:{price:0, power:0, noise:0},
      desc:'시선/표정/반응 데이터 기반 하이라이트(데모)', params:[{key:'privacy',label:'프라이버시',type:'select',options:['기기내 처리','클라우드']}] },

    { id:'taste-sensor', icon:'👅', name:'미각 전기자극 센서(실험용)', base:{price:0, power:0, noise:0},
      desc:'AR 음식 연동 미각 자극(실험/안전 확인 전 미사용)', safety:'인체 자극 장치: 의료·안전 검증 전 시연용 UI만 구현' }
  ];

  // ===================== 전역 상태 =====================
  const state = {
    filters: { sort:'전체', type:'전체', area:'전체', rooms:'전체', bays:'전체', family:'전체', style:'전체' },
    limit: 12,
    likes: JSON.parse(localStorage.getItem('likes.v1')||'{}'),
    bookmarks: JSON.parse(localStorage.getItem('bookmarks.v1')||'[]'),
    builder: JSON.parse(localStorage.getItem('builder.v1')||'{}'), // {items:[{id,name,price,power,noise,pos}], room:{w,d}}
    options: JSON.parse(localStorage.getItem('options.v2')||'{}')  // {id:{qty:number, params:{}, required:boolean}}
  };

  // ===================== 라우팅 =====================
  const pageGallery = document.getElementById('page-gallery');
  const pageOptions = document.getElementById('page-options');
  const pageBuilder = document.getElementById('page-builder');
  const navGallery = document.getElementById('navGallery');
  const navOptions = document.getElementById('navOptions');
  const navBuilder = document.getElementById('navBuilder');

  function route(){
    const hash = location.hash || '#/gallery';
    const path = hash.split('?')[0];
    const isGallery = path.startsWith('#/gallery');
    const isOptions = path.startsWith('#/options');
    pageGallery.hidden = !isGallery;
    pageOptions.hidden = !isOptions;
    pageBuilder.hidden = isGallery || isOptions;
    navGallery.classList.toggle('active', isGallery);
    navOptions.classList.toggle('active', isOptions);
    navBuilder.classList.toggle('active', !isGallery && !isOptions);
  }
  window.addEventListener('hashchange', route);

  // ===================== 엘리먼트 참조 =====================
  const grid = document.getElementById('grid');
  const toast = document.getElementById('toast');
  const fSort = document.getElementById('fSort');
  const fType = document.getElementById('fType');
  const fArea = document.getElementById('fArea');
  const fRooms = document.getElementById('fRooms');
  const fBays = document.getElementById('fBays');
  const fFamily = document.getElementById('fFamily');
  const fStyle = document.getElementById('fStyle');
  const btnMore = document.getElementById('btnMore');
  const btnShareView = document.getElementById('btnShareView');
  const btnToBuilder = document.getElementById('btnToBuilder');

  // 빌더
  const canvas = document.getElementById('canvas');
  const selectedList = document.getElementById('selectedList');
  const sumPrice = document.getElementById('sumPrice');
  const sumPower = document.getElementById('sumPower');
  const sumNoise = document.getElementById('sumNoise');
  const sumView = document.getElementById('sumView');
  const btnShareBuild = document.getElementById('btnShareBuild');
  const btnClear = document.getElementById('btnClear');
  const bookmarksBox = document.getElementById('bookmarksBox');

  // 옵션
  const optionsGrid = document.getElementById('optionsGrid');
  const btnOptionsToBuilder = document.getElementById('btnOptionsToBuilder');
  const btnOptionsClear = document.getElementById('btnOptionsClear');
  const basketCount = document.getElementById('basketCount');
  const basketSum = document.getElementById('basketSum');

  // ===================== 갤러리 로직 =====================
  function applyFiltersAndSort(list, f){
    let arr = list.filter(x =>
      (f.type==='전체' || x.type===f.type) &&
      (f.area==='전체' || x.area===f.area) &&
      (f.rooms==='전체' || x.rooms===f.rooms) &&
      (f.bays==='전체' || x.bays===f.bays) &&
      (f.family==='전체' || x.family===f.family) &&
      (f.style==='전체' || x.style===f.style)
    );
    if(f.sort==='전체') arr.sort((a,b)=>b.pop-a.pop);
    if(f.sort==='최신순') arr.sort((a,b)=>b.ts-a.ts);
    if(f.sort==='평점순') arr.sort((a,b)=>b.rating-a.rating);
    return arr;
  }

  function renderGallery(){
    const arr = applyFiltersAndSort(DEMO, state.filters).slice(0, state.limit);
    grid.innerHTML = '';
    for(const p of arr){
      const li = document.createElement('li');
      li.innerHTML = cardHTML(p, !!state.likes[p.id], isBookmarked(p.id));
      grid.appendChild(li);
    }
    // 바인딩
    grid.querySelectorAll('button[data-like]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-like');
        state.likes[id] = !state.likes[id];
        localStorage.setItem('likes.v1', JSON.stringify(state.likes));
        renderGallery();
      })
    });
    grid.querySelectorAll('button[data-bookmark]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-bookmark');
        const data = DEMO.find(x=>x.id===id);
        toggleBookmark(data);
        renderGallery();
        showToast(isBookmarked(id) ? '북마크에 추가됨' : '북마크 해제');
        renderBookmarksBox();
      })
    });
    grid.querySelectorAll('button[data-to-builder]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-to-builder');
        const data = DEMO.find(x=>x.id===id);
        const item = toBuilderItem(data);
        addToBuilder(item);
        location.hash = '#/builder';
      })
    });
  }

  function cardHTML(p, liked, bookmarked){
    const tags = p.tags.map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join('');
    return `
      <article class="card" aria-labelledby="title-${p.id}">
        <figure class="thumb" aria-label="썸네일">${escapeHTML(p.thumb)}</figure>
        <div class="card-body">
          <div class="card-head">
            <h3 id="title-${p.id}" class="title">${escapeHTML(p.title)}</h3>
            <div class="small">${escapeHTML(p.type)} · ${escapeHTML(p.area)}</div>
          </div>
          <p class="meta">스타일: ${escapeHTML(p.style)} · 평점 ${p.rating.toFixed(1)}</p>
          <div class="tags" aria-label="태그">${tags}</div>
          <div class="actions">
            <button class="chip-btn ${liked?'on':''}" data-like="${p.id}" type="button">${liked?'♥ 북마크됨':'♡ 좋아요'}</button>
            <button class="chip-btn ${bookmarked?'on':''}" data-bookmark="${p.id}" type="button">${bookmarked?'★ 북마크 해제':'☆ 북마크'}</button>
            <button class="chip-btn" data-to-builder="${p.id}" type="button">이 구성으로 빌더</button>
          </div>
        </div>
      </article>`;
  }

  function isBookmarked(id){ return state.bookmarks.some(x=>x.id===id); }
  function toggleBookmark(data){
    const exists = isBookmarked(data.id);
    if(exists){ state.bookmarks = state.bookmarks.filter(x=>x.id!==data.id); }
    else { state.bookmarks = [...state.bookmarks, { id:data.id, title:data.title, thumb:data.thumb }]; }
    localStorage.setItem('bookmarks.v1', JSON.stringify(state.bookmarks));
  }

  // ===================== 옵션 페이지 로직 (배민-마라탕 스타일) =====================
  function renderOptions(){
    optionsGrid.innerHTML = '';
    OPTIONS.forEach(opt=>{
      const sel = state.options[opt.id] || { qty: opt.required? 1 : 0, params:{} };
      const qty = sel.qty||0;
      const div = document.createElement('div');
      div.className = 'opt-card';
      const priceLine = `${fmt(opt.base.price)}원${opt.unit?` / ${opt.unit}`:''}`;
      div.innerHTML = `
        <h4>${opt.icon} ${escapeHTML(opt.name)} ${opt.required?'<span class="small" style="margin-left:6px;color:var(--danger)">필수</span>':''}</h4>
        <div class="opt-body">
          <div class="small">${escapeHTML(opt.desc || '')}</div>
          ${opt.safety ? `<div class="small" style="color:var(--danger)">안전/윤리: ${escapeHTML(opt.safety)}</div>` : ''}
          ${opt.depends ? `<div class="small">의존성: ${escapeHTML(opt.depends)}</div>` : ''}
          ${(opt.params||[]).map(p => paramLine(opt.id, p, sel.params[p.key])).join('')}
          <div class="kv"><span>가격</span><strong>${priceLine}</strong></div>
          <div class="kv" aria-label="수량 조절">
            <span>수량${opt.required?' (최소 1)': ''}</span>
            <span class="qty">
              <button type="button" data-dec="${opt.id}">-</button>
              <input id="qty-${opt.id}" value="${qty}" inputmode="numeric" aria-label="수량" readonly>
              <button type="button" data-inc="${opt.id}">+</button>
            </span>
          </div>
        </div>`;
      optionsGrid.appendChild(div);
    });

    // 파라미터 바인딩
    optionsGrid.querySelectorAll('[data-param-key]').forEach(el=>{
      el.addEventListener('change',()=>{
        const id = el.getAttribute('data-opt');
        const key = el.getAttribute('data-param-key');
        state.options[id] = state.options[id] || {qty:0, params:{}};
        state.options[id].params[key] = el.value;
        persistOptions();
        renderBasket();
      })
    });

    // 수량 스테퍼 바인딩
    optionsGrid.querySelectorAll('button[data-inc]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.getAttribute('data-inc');
        incQty(id, +1);
      })
    });
    optionsGrid.querySelectorAll('button[data-dec]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.getAttribute('data-dec');
        incQty(id, -1);
      })
    });

    renderBasket();
  }

  function paramLine(optId, p, val){
    if(p.type==='select'){
      const opts = p.options.map(o=>`<option ${val===o?'selected':''}>${escapeHTML(o)}</option>`).join('');
      return `<div class="opt-line"><label for="${optId}-${p.key}">${escapeHTML(p.label)}</label><select id="${optId}-${p.key}" data-opt="${optId}" data-param-key="${p.key}">${opts}</select></div>`;
    }
    if(p.type==='text'){
      return `<div class="opt-line"><label for="${optId}-${p.key}">${escapeHTML(p.label)}</label><input type="text" id="${optId}-${p.key}" data-opt="${optId}" data-param-key="${p.key}" placeholder="${escapeHTML(p.placeholder||'')}" value="${escapeHTML(val||'')}"></div>`;
    }
    if(p.type==='number'){
      return `<div class="opt-line"><label for="${optId}-${p.key}">${escapeHTML(p.label)}</label><input type="number" id="${optId}-${p.key}" data-opt="${optId}" data-param-key="${p.key}" value="${escapeHTML(val||'')}"></div>`;
    }
    return '';
  }

  function incQty(id, delta){
    const meta = OPTIONS.find(o=>o.id===id); if(!meta) return;
    const max = meta.qtyMax || 99; const min = meta.required ? 1 : 0;
    state.options[id] = state.options[id] || {qty:0, params:{}};
    const cur = state.options[id].qty||0;
    const next = clamp(cur + delta, min, max);
    state.options[id].qty = next;
    const input = document.getElementById('qty-'+id); if(input) input.value = next;
    persistOptions();
    renderBasket();
  }

  function persistOptions(){ localStorage.setItem('options.v2', JSON.stringify(state.options)); }

  function getBasket(){
    const entries = Object.entries(state.options);
    const items = [];
    for(const [id,conf] of entries){
      const meta = OPTIONS.find(o=>o.id===id); if(!meta) continue;
      const qty = +conf.qty||0; if(qty<=0) continue;
      const unit = meta.unit? ` x${qty} ${meta.unit}` : (qty>1?` x${qty}`:'');
      items.push({
        id: 'opt-'+id,
        name: `${meta.name}${unit}${confSuffix(conf.params)}`,
        price: meta.base.price * qty,
        power: meta.base.power * qty,
        noise: meta.base.noise, // 소음은 평균 가정
        icon: meta.icon,
        qty
      });
    }
    return items;
  }

  function renderBasket(){
    const items = getBasket();
    const total = items.reduce((a,b)=>a+(+b.price||0),0);
    basketCount.textContent = items.reduce((a,b)=>a+(+b.qty||0),0);
    basketSum.textContent = fmt(total)+' 원';
  }

  btnOptionsToBuilder?.addEventListener('click',()=>{
    // 필수 항목 확인
    const requiredMetas = OPTIONS.filter(o=>o.required);
    for(const m of requiredMetas){
      const sel = state.options[m.id];
      if(!sel || !sel.qty || sel.qty<1){ showToast(`필수 옵션: "${m.name}"을(를) 1 이상 선택하세요`); return; }
    }
    const basket = getBasket();
    if(!basket.length){ showToast('선택된 옵션이 없습니다'); return; }
    basket.forEach(addToBuilder);
    showToast('옵션이 빌더에 추가되었습니다');
    location.hash = '#/builder';
  });

  function confSuffix(params){
    if(!params) return '';
    const keys = Object.keys(params).filter(k=>params[k]);
    if(!keys.length) return '';
    return ' ['+ keys.map(k=>`${k}:${params[k]}`).join(', ') +']';
  }

  btnOptionsClear?.addEventListener('click',()=>{ state.options = {}; persistOptions(); renderOptions(); renderBasket(); });

  // ===================== 빌더 로직 =====================
  function toBuilderItem(p){
    return { id:p.id, name:p.title, price:300000, power:120, noise:28, pos:{x:50,y:70}, icon:p.thumb };
  }

  function addToBuilder(item){
    const cur = state.builder.items || [];
    state.builder.items = [...cur, item];
    persistBuilder();
    renderBuilder();
  }

  function renderBuilder(){
    const items = state.builder.items || [];
    selectedList.innerHTML = items.length? '' : '<div class="small">선택된 항목이 없습니다. 갤러리/옵션에서 추가하세요.</div>';
    items.forEach((it, idx)=>{
      const row = document.createElement('div');
      row.className = 'kv';
      row.innerHTML = `<span>${escapeHTML(it.name)}</span>
        <span>
          <button class="chip-btn" data-move="${idx}" type="button">배치</button>
          <button class="chip-btn" data-del="${idx}" type="button">삭제</button>
        </span>`;
      selectedList.appendChild(row);
    });

    const price = items.reduce((a,b)=>a+(+b.price||0),0);
    const power = items.reduce((a,b)=>a+(+b.power||0),0);
    const noiseList = items.map(i=>+i.noise||0).filter(n=>n>0);
    const noise = noiseList.length ? Math.round(noiseList.reduce((a,b)=>a+b,0)/noiseList.length) : 0;
    const screenInch = 100; // 데모 고정
    const viewDist = (screenInch/100)*2.5;
    sumPrice.textContent = fmt(price)+ ' 원';
    sumPower.textContent = power + ' W';
    sumNoise.textContent = noise + ' dB';
    sumView.textContent = viewDist.toFixed(1) + ' m';

    renderCanvas();

    selectedList.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const i = +btn.getAttribute('data-del');
        (state.builder.items||[]).splice(i,1);
        persistBuilder();
        renderBuilder();
      })
    });
    selectedList.querySelectorAll('button[data-move]').forEach(btn=>{
      btn.addEventListener('click',()=>{ const i = +btn.getAttribute('data-move'); focusItemOnCanvas(i); })
    });
  }

  function renderCanvas(){
    canvas.innerHTML = '<div class="ghost-guide"></div><div class="seat-guide"></div>';
    const items = state.builder.items || [];
    items.forEach((it, idx)=>{
      const el = document.createElement('div');
      el.className = 'item';
      el.style.left = (it.pos?.x||50) + '%';
      el.style.top  = (it.pos?.y||70) + '%';
      el.setAttribute('data-idx', idx);
      el.innerHTML = `<div class="dot" title="${escapeHTML(it.name)}">${escapeHTML(it.icon||'🔧')}</div>`;
      canvas.appendChild(el);
    });
    canvas.querySelectorAll('.item').forEach(el=>{
      el.addEventListener('mousedown', startDrag);
      el.addEventListener('touchstart', startDrag, {passive:false});
    });
  }

  function startDrag(ev){
    ev.preventDefault();
    const el = ev.currentTarget;
    const idx = +el.getAttribute('data-idx');
    const rect = canvas.getBoundingClientRect();
    const start = getPos(ev);
    const init = { x: (state.builder.items[idx].pos?.x)||50, y:(state.builder.items[idx].pos?.y)||70 };
    function move(e){
      const p = getPos(e);
      const dx = p.x - start.x; const dy = p.y - start.y;
      const nx = clamp(init.x + (dx/rect.width)*100, 0, 100);
      const ny = clamp(init.y + (dy/rect.height)*100, 0, 100);
      el.style.left = nx+'%'; el.style.top = ny+'%';
      state.builder.items[idx].pos = { x:nx, y:ny };
    }
    function up(){
      window.removeEventListener('mousemove', move);
      window.removeEventListener('mouseup', up);
      window.removeEventListener('touchmove', move);
      window.removeEventListener('touchend', up);
      persistBuilder();
    }
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', up);
    window.addEventListener('touchmove', move);
    window.addEventListener('touchend', up);
  }

  function getPos(e){ const t = e.touches? e.touches[0] : e; return { x:t.clientX, y:t.clientY }; }
  function clamp(n,a,b){ return Math.min(b, Math.max(a,n)); }
  function fmt(n){ try{return Number(n||0).toLocaleString('ko-KR')}catch{return n+''} }

  function focusItemOnCanvas(i){ const el = canvas.querySelector(`.item[data-idx="${i}"]`); if(!el) return; el.animate([{transform:'translate(-50%,-50%) scale(1)'},{transform:'translate(-50%,-50%) scale(1.12)'}],{duration:200}); }

  function renderBookmarksBox(){
    const list = state.bookmarks;
    if(!list.length){ bookmarksBox.textContent = '(북마크가 없습니다)'; return; }
    bookmarksBox.innerHTML = '';
    list.forEach(b=>{
      const div = document.createElement('div');
      div.className = 'kv';
      div.innerHTML = `<span>${escapeHTML(b.title)}</span>
        <span>
          <button class="chip-btn" data-import="${b.id}" type="button">빌더로 가져오기</button>
          <button class="chip-btn" data-rm="${b.id}" type="button">삭제</button>
        </span>`;
      bookmarksBox.appendChild(div);
    });
    bookmarksBox.querySelectorAll('button[data-import]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.getAttribute('data-import');
        const src = state.bookmarks.find(x=>x.id===id);
        if(!src) return;
        addToBuilder({ id:src.id, name:src.title, price:300000, power:120, noise:28, pos:{x:50,y:70}, icon:src.thumb });
        showToast('북마크에서 추가됨');
      })
    });
    bookmarksBox.querySelectorAll('button[data-rm]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.getAttribute('data-rm');
        state.bookmarks = state.bookmarks.filter(x=>x.id!==id);
        localStorage.setItem('bookmarks.v1', JSON.stringify(state.bookmarks));
        renderBookmarksBox();
      })
    });
  }

  function persistBuilder(){ localStorage.setItem('builder.v1', JSON.stringify(state.builder)); }

  // ===================== 공유/퍼시스트 =====================
  function persistFilters(){
    try{
      const s = JSON.stringify({filters:state.filters,limit:state.limit});
      localStorage.setItem('interior3d.gallery.v1', s);
      const hash = btoa(encodeURIComponent(s));
      if(location.hash.startsWith('#/gallery')){
        history.replaceState(null,'', '#/gallery?state='+hash);
      }
    }catch{}
  }
  function restoreFiltersFromHash(){
    try{
      const q = new URLSearchParams((location.hash.split('?')[1]||''));
      const h = q.get('state'); if(!h) return;
      const json = decodeURIComponent(atob(h));
      const obj = JSON.parse(json);
      if(obj.filters) state.filters = obj.filters;
      if(obj.limit) state.limit = obj.limit;
    }catch{}
  }

  // ===================== 유틸 =====================
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
  function showToast(msg){ toast.textContent = msg; toast.classList.remove('hide'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.add('hide'),1500); }

  // ===================== 이벤트/초기화 =====================
  ;(function init(){
    // 필터 UI 초기값 복원
    restoreFiltersFromHash();
    const f = state.filters;
    fSort.value=f.sort; fType.value=f.type; fArea.value=f.area; fRooms.value=f.rooms; fBays.value=f.bays; fFamily.value=f.family; fStyle.value=f.style;
    // 필터 변경
    ;[fSort,fType,fArea,fRooms,fBays,fFamily,fStyle].forEach(sel=> sel.addEventListener('change',()=>{
      state.filters = { sort:fSort.value, type:fType.value, area:fArea.value, rooms:fRooms.value, bays:fBays.value, family:fFamily.value, style:fStyle.value };
      state.limit = Math.max(12, state.limit);
      persistFilters();
      renderGallery();
    }));

    btnMore.addEventListener('click',()=>{ state.limit+=12; persistFilters(); renderGallery(); });
    btnShareView.addEventListener('click',()=>{
      try{ const s = JSON.stringify({filters:state.filters,limit:state.limit}); const h=btoa(encodeURIComponent(s)); const url=location.origin+location.pathname+'#/gallery?state='+h; navigator.clipboard&&navigator.clipboard.writeText(url); showToast('현재 보기 링크가 복사되었습니다'); }catch{ showToast('공유 실패'); }
    });
    btnToBuilder.addEventListener('click',()=>{ location.hash = '#/builder'; });

    btnShareBuild.addEventListener('click',()=>{
      try{ const s = btoa(encodeURIComponent(JSON.stringify(state.builder||{}))); const url = location.origin+location.pathname+'#/builder?build='+s; navigator.clipboard&&navigator.clipboard.writeText(url); showToast('설계 링크가 복사되었습니다'); }catch{ showToast('공유 실패'); }
    });
    btnClear.addEventListener('click',()=>{ state.builder={}; persistBuilder(); renderBuilder(); renderCanvas(); });

    // 옵션 페이지 초기 렌더
    renderOptions();

    // 빌더: 해시로 설계 불러오기
    (function restoreBuildFromHash(){
      try{ const qs = new URLSearchParams(location.hash.split('?')[1]||''); const b = qs.get('build'); if(!b) return; const json = decodeURIComponent(atob(b)); const obj = JSON.parse(json); if(obj && obj.items) { state.builder=obj; persistBuilder(); } }catch{}
    })();

    renderGallery();
    renderBuilder();
    renderBookmarksBox();
    route();
  })();
  </script>
</body>
</html>
